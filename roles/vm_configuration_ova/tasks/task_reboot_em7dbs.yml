---
# tasks to reboot the EM7 DB VM
- block:
  - name: reboot the EM7 DB
    community.vmware.vmware_guest_powerstate:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      validate_certs: false
      name: "{{ hostvars[groups['em7db']|first if db_element == 'first' else groups['em7db']|last]['vm']['name'] }}"
      state: "{{ 'powered-on' if db_element == 'first' else 'restarted' }}"
      state_change_timeout: 60
    register: reg_reboot_db
    failed_when:
      - reg_reboot_db is failed or (reg_reboot_db.msg is defined and reg_reboot_db.msg != 'Unable to set power state for non-existing virtual machine')
    ignore_errors: yes
  - name: wait until db vip is reachable
    ansible.builtin.shell: ping {{ vip.db }} -c 1
    become: "{{ 'yes' if host_os|lower is search('almalinux|ubuntu') else 'no' }}"
    retries: 30
    delay: 10
    register: db_vip_reachable2
    until: db_vip_reachable2 is succeeded
    when: reg_reboot_db is succeeded
  delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"
  run_once: true
