---
# tasks to get cluster name
- block:
  - name: Get cluster facts
    vmware_cluster_facts:
      hostname: "{{hostvars[groups['vcenter'][0]]['information']['address']}}"
      username: "{{hostvars[groups['vcenter'][0]]['credentials']['username']}}"
      password: "{{hostvars[groups['vcenter'][0]]['credentials']['password']}}"
      datacenter: "{{hostvars[groups['vcenter'][0]]['information']['datacenter']}}"
      validate_certs: no
    register: cluster_facts
    check_mode: no
    delegate_to: "{{groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost'}}"

  - name: define cluster_name
    set_fact:
      cluster_name: "{{cluster_name|default([]) + [item.key] | unique}}"
    loop:  "{{cluster_facts.clusters|dict2items}}"

  - name: define information.cluster
    set_fact:
      information: "{{information | default({}) | combine(new_item, recursive=true)}}"
    vars:
      new_item: "{'cluster': '{{cluster_name|first}}'}"

#  no_log: true
  tags:   tags: ['capcheck', 'vms']

