---
# tasks file for capcheck
- block:
  - name: get list of stack groups in play
    set_fact:
      play_stack_group_list: "{{ play_stack_group_list|default([]) | union([host_item[:-2]]) }}"
    loop: "{{ ansible_play_hosts | reject('match', 'dr*|bastion*|puppet*|vcenter*|nexus*') | list }}"
    loop_control:
      loop_var: host_item
      label: "{{ host_item }}"

  - name: get list of DR groups in play
    set_fact:
      play_dr_group_list: "{{ play_dr_group_list|default([]) | union([host_item[:-2]]) }}"
    loop: "{{ ansible_play_hosts | select('match', 'dr*') | list }}"
    loop_control:
      loop_var: host_item
      label: "{{ host_item }}"
    when: customer.disaster_recovery

  - include_tasks: task_get_required_space.yml

  - block:
    - include_tasks: task_get_cluster_name.yml
      when:
        - information.cluster is not defined or information.cluster == ''

# Not to be used until https://github.com/ansible/ansible/pull/67641 is released
#    - include_tasks: task_get_hosts_list.yml
#      when:
#        - information.resources is not defined or information.resources == []

    - include_tasks: task_get_datastore_facts.yml
    when:
      - information.deptype == 'h'

  - include_tasks: task_get_host_facts.yml
    when:
      - information.deptype == 'a'

  when: capcheck | default(false) | bool
  tags: ['capcheck', 'vm_creation', 'puppet', 'infra_configure', 'infra_build_nodes']

