---
# tasks to get datastore facts
- name: Get datastore facts
  vmware_datastore_facts:
    hostname: "{{hostvars[groups['vcenter'][0]]['information']['address']}}"
    username: "{{hostvars[groups['vcenter'][0]]['credentials']['username']}}"
    password: "{{hostvars[groups['vcenter'][0]]['credentials']['password']}}"
    datacenter: "{{hostvars[groups['vcenter'][0]]['information']['datacenter']}}"
    validate_certs: no
  register: datastore_facts
  delegate_to: "{{groups['bastion'][0] if (groups['bastion'] | length >= 1 and hostvars[groups['bastion'][0]]['ansible_host'] != '') else 'localhost'}}"
  tags: capcheck

- set_fact:
    hs_ds_names: "{{hs_ds_names|default([]) + [item.name]}}"
  loop: "{{datastore_facts.datastores | sort(attribute='freeSpace', reverse=true)}}"
  when: item.freeSpace >= (required_space|float * 1024|pow(3)) / 2
  tags: capcheck

- block:
  - set_fact:
      db_ds_names: "{{hs_ds_names}}"
      vm_ds_names: "{{hs_ds_names}}"
  - debug:
      msg: "Found {{hs_ds_names|length}} datastores that have enough space for half the VMs"
  when: hs_ds_names|length >= 2
  tags: capcheck

- block:
  - set_fact:
      db_ds_names: "{{db_ds_names|default([]) + [item.name]}}"
    loop: "{{datastore_facts.datastores | sort(attribute='freeSpace', reverse=true)}}"
    when: item.freeSpace >= hostvars[groups['em7db'][0]]['vm']['disk']|float * 1024|pow(3)
  - set_fact:
      intvm_ds_names: "{{intvm_ds_names|default([]) + [item.name]}}"
    loop: "{{datastore_facts.datastores | difference(db_ds_names) | sort(attribute='freeSpace', reverse=true)}}"
    when: item.freeSpace >= (((required_space|float / 2) - hostvars[groups['em7db'][0]]['vm']['disk']|float) * 1024|pow(3))
  - set_fact:
      com_ds_names: "{{com_ds_names|default([]) + item}}"
    vars:
      myvar: "{{datastore_facts.datastores|selectattr('name', 'equalto', item)|map(attribute='freeSpace', reverse=true)|list}}"
    loop: "{{db_ds_names}}"
    when: myvar[0] >= (required_space|float * 1024|pow(3)) / 2
  - set_fact:
      vm_ds_names: "{{com_ds_names | union(intvm_ds_names) | unique}}"
  when: hs_ds_names|length < 2
  tags: capcheck

- name: define db_ds_total_fs
  set_fact:
    db_ds_total_fs: "{{db_ds_total_fs|default(0)|int + myvar[0]}}"
  vars:
    myvar: "{{datastore_facts.datastores|selectattr('name', 'equalto', item)|map(attribute='freeSpace')|list}}"
  loop: "{{db_ds_names}}"
  tags: capcheck

- name: define vm_ds_total_fs
  set_fact:
    vm_ds_total_fs: "{{vm_ds_total_fs|default(0)|int + myvar[0]}}"
  vars:
    myvar: "{{datastore_facts.datastores|selectattr('name', 'equalto', item)|map(attribute='freeSpace')|list}}"
  loop: "{{vm_ds_names}}"
  tags: capcheck
