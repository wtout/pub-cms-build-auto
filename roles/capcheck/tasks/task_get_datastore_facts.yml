---
# tasks to get datastore facts
- name: Get datastore facts
  vmware_datastore_facts:
    hostname: "{{hostvars[groups['vcenter'][0]]['information']['address']}}"
    username: "{{hostvars[groups['vcenter'][0]]['credentials']['username']}}"
    password: "{{hostvars[groups['vcenter'][0]]['credentials']['password']}}"
    datacenter: "{{hostvars[groups['vcenter'][0]]['information']['datacenter']}}"
    cluster: "{{hostvars[groups['vcenter'][0]]['information']['cluster']}}"
    validate_certs: no
  register: datastore_facts
  delegate_to: "{{groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost'}}"
  tags: ['capcheck', 'vm_creation']

- name: Initialize found datastores list
  set_fact:
    hs_ds_names: []
  tags: ['capcheck', 'vm_creation']

- set_fact:
    hs_ds_names: "{{hs_ds_names|default([]) + [item.name]}}"
  loop: "{{datastore_facts.datastores | sort(attribute='freeSpace', reverse=true)}}"
  when: item.freeSpace >= (required_space|float * 1024|pow(3)) / 2
  tags: ['capcheck', 'vm_creation']

- assert:
    that:
      - "hs_ds_names|length > 0"
    fail_msg: "Found no datastores with enough storage space to deploy the environment"
  tags: ['capcheck', 'vm_creation']

- block:
  - name: define lists of datastores that have enough space for half the vms
    set_fact:
      db_ds_names: "{{hs_ds_names if groups['em7db'] is defined else []}}"
      ndb_ds_names: "{{hs_ds_names}}"
  - debug:
      msg: "Found {{hs_ds_names|length}} datastores that have enough space for half the vm_creation"
  when: hs_ds_names|length >= 2
  tags: ['capcheck', 'vm_creation']

- block:
  - name: define list of datastores to host the DB vms
    set_fact:
      db_ds_names: "{{db_ds_names|default([]) + [item.name]}}"
    loop: "{{datastore_facts.datastores | sort(attribute='freeSpace', reverse=true)}}"
    when:
      - groups['em7db'] is defined
      - item.freeSpace >= (hostvars[groups['em7db'][0]]['vm']['disk']|float + hostvars[groups['em7db'][0]]['vm']['memory']|float) * 1024|pow(3)
  - name: define intermediate list of datastores
    set_fact:
      intndb_ds_names: "{{intndb_ds_names|default([]) + [item.name]}}"
    loop: "{{datastore_facts.datastores | difference(db_ds_names|default([])) | sort(attribute='freeSpace', reverse=true)}}"
    when:
      - item.freeSpace >= (((required_space|float / 2) - (hostvars[groups['em7db'][0]]['vm']['disk']|float - hostvars[groups['em7db'][0]]['vm']['memory']|float) * 1024|pow(3) if groups['em7db'] is defined else 0))
  - name: define the list of common datastores
    set_fact:
      com_ds_names: "{{com_ds_names|default([]) + item}}"
    vars:
      myvar: "{{datastore_facts.datastores|selectattr('name', 'equalto', item)|map(attribute='freeSpace', reverse=true)|list}}"
    loop: "{{db_ds_names|default([])}}"
    when: myvar[0] >= (required_space|float * 1024|pow(3)) / 2
  - name: define the list of datastores to host the non-DB vms
    set_fact:
      ndb_ds_names: "{{com_ds_names|default([]) | union(intndb_ds_names) | unique}}"
  when: hs_ds_names|length < 2
  tags: ['capcheck', 'vm_creation']

- name: define db_ds_total_fs
  set_fact:
    db_ds_total_fs: "{{db_ds_total_fs|default(0)|int + myvar[0]}}"
  vars:
    myvar: "{{datastore_facts.datastores|selectattr('name', 'equalto', item)|map(attribute='freeSpace')|list}}"
  loop: "{{db_ds_names|default([])}}"
  tags: ['capcheck', 'vm_creation']

- name: define ndb_ds_total_fs
  set_fact:
    ndb_ds_total_fs: "{{ndb_ds_total_fs|default(0)|int + myvar[0]}}"
  vars:
    myvar: "{{datastore_facts.datastores|selectattr('name', 'equalto', item)|map(attribute='freeSpace')|list}}"
  loop: "{{ndb_ds_names|default([])}}"
  tags: ['capcheck', 'vm_creation']
