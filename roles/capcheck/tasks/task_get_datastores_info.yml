---
# tasks file for create_vm
- name: Get datastore info
  vmware_datastore_facts:
    hostname: "{{hostvars[groups['vcenter'][0]]['vcenter']['address']}}"
    username: "{{hostvars[groups['vcenter'][0]]['vcenter']['username']}}"
    password: "{{hostvars[groups['vcenter'][0]]['vcenter']['password']}}"
    datacenter: "{{datacenter.name}}"
    validate_certs: no
  register: ds_facts
  delegate_to: "{{groups['bastion'][0] if groups['bastion'] | length >= 1 else 'localhost'}}"
  when:
    - (groups['bastion'] | length >= 1 and hostvars[groups['bastion'][0]]['bastion_creds'] is succeeded) or groups['bastion'] | length == 0
  tags: capcheck

- set_fact:
    db_ds_names: "{{db_ds_names | default([]) + [item.name]}}"
  loop: "{{ds_facts.datastores | sort(attribute='freeSpace')}}"
  when: item.freeSpace >= datastore.db_min
  tags: capcheck

- set_fact:
    db_ds_total_fs: "{{db_ds_total_fs|default(0)|int + item.freeSpace|int}}"
  loop: "{{ds_facts.datastores}}"
  when: item.freeSpace >= datastore.db_min
  tags: capcheck

- set_fact:
    vm_ds_names: "{{vm_ds_names | default([]) + [item.name]}}"
  loop: "{{ds_facts.datastores | sort(attribute='freeSpace')}}"
  when: item.freeSpace >= datastore.vm_min
  tags: capcheck

- set_fact:
    vm_ds_total_fs: "{{vm_ds_total_fs|default(0)|int + item.freeSpace|int}}"
  loop: "{{ds_facts.datastores}}"
  when: item.freeSpace >= datastore.vm_min
  tags: capcheck

- debug:
    msg:
      - "{{db_ds_names}}"
      - "{{db_ds_names|last}}: {{ds_facts.datastores|selectattr('name', 'equalto', db_ds_names|last)|map(attribute='freeSpace')|list|regex_replace('\\[|\\]', '')}}"
      - "{{(db_ds_total_fs|int / 1024|pow(4))|string + ' TiB' if db_ds_total_fs|length > 12 else (db_ds_total_fs|int / 1024|pow(3))|string + ' GiB'}}"
      - "{{vm_ds_names}}"
      - "{{vm_ds_names|last}}: {{ds_facts.datastores|selectattr('name', 'equalto', vm_ds_names|last)|map(attribute='freeSpace')|list|regex_replace('\\[|\\]', '')}}"
      - "{{(vm_ds_total_fs|int / 1024|pow(4))|string + ' TiB' if vm_ds_total_fs|length > 12 else (vm_ds_total_fs|int / 1024|pow(3))|string + ' GiB'}}"
  tags: capcheck
