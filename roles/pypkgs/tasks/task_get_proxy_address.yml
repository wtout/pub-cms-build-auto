---
# Tasks to define the proxy address
- block:
  - name: get proxy setting
    shell: grep -r "^proxy.*=.*ht" /etc/environment /etc/profile ~/.bashrc ~/.bash_profile | cut -d '"' -f2 | uniq
    register: proxy_string
    no_log: true
    check_mode: no

  - name: define proxy_address
    set_fact:
      proxy_address: "{{ proxy_string.stdout }}"
    no_log: "{{ true if proxy_string.stdout is regex(':.*@') else false }}"

  - name: validate detected proxy setting
    uri:
      url: "https://www.cisco.com"
    register: validate_proxy1
    ignore_errors: "{{ true if proxy_address != '' else false }}"
    environment:
      http_proxy: "{{ proxy_address }}"
      https_proxy: "{{ proxy_address }}"

  - block:
    - name: update proxy_address
      set_fact:
        proxy_address: "{{ proxy_address | regex_replace('//.*@', '//') | regex_replace('//', '//' + SVC_USER + ':' + SVC_PASS + '@') }}"
      no_log: true
    - name: validate updated proxy setting
      uri:
        url: "https://www.cisco.com"
      register: validate_proxy2
      ignore_errors: true
      environment:
        http_proxy: "{{ proxy_address }}"
        https_proxy: "{{ proxy_address }}"
    - name: check if updated proxy address failed
      assert:
        that:
          - validate_proxy2 is succeeded
        fail_msg: "{{ SVC_USER }} service account credentials are not valid for the detected proxy. Aborting!"
    when:
      - validate_proxy1 is failed

  delegate_to: "{{ host_delegate|default('localhost') }}"
  run_once: true
  tags: [ 'always', 'pypkgs' ]
