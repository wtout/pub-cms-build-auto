---
# Tasks to delete the puppet certificate
- block:
  - name: check if there is a cert on the VM
    stat:
      path: "/etc/puppetlabs/puppet/ssl/certs/{{vm.name}}.{{sysconfig.domain_name}}.pem"
    register: client_cert_status
  - debug:
      msg: "Found no client certificate on {{inventory_hostname}}"
    when: not client_cert_status.stat.exists

  - name: check if there is a cert on the puppet server
    shell: puppet cert list {{'em7release.' if 'em7' in group_names else ''}}{{vm.name}}.{{sysconfig.domain_name}} | cut -d '(' -f2
    args:
      chdir: '/usr/local/bin'
    check_mode: no
    ignore_errors: true
    register: client_cert_on_server
    delegate_to: "{{groups['puppet']|first}}"

  - debug:
      msg: "Found no client certificate for {{inventory_hostname}} on puppet server"
    when:
      - client_cert_on_server.stderr != ''
      - "'Could not find a certificate for' in client_cert_on_server.stderr"

  - name: check if client cert fingerprint matches cert on server
    shell: openssl x509 -text -noout -{{client_cert_on_server.stdout.split(' ')[0] | replace(')', '')}} -fingerprint -in certs/{{vm.name}}.{{sysconfig.domain_name}}.pem | tail -1 | cut -d '=' -f2 | grep {{client_cert_on_server.stdout.split(' ')[1]}}
    args:
      chdir: '/etc/puppetlabs/puppet/ssl'
    register: client_cert_match
    check_mode: no
    when:
      - client_cert_status.stat.exists
      - client_cert_on_server.stdout != ''
      - client_cert_on_server.stderr == ''

  - name: define delete client cert on VM
    set_fact:
      delete_client_cert_on_vm: true
    when:
      - client_cert_status.stat.exists
      - client_cert_on_server.stderr != '' or client_cert_match is failed

  - name: define delete client cert on puppet server
    set_fact:
      delete_client_cert_on_server: true
    when:
      - client_cert_on_server.stdout != ''
      - client_cert_on_server.stderr == ''
      - not client_cert_status.stat.exists or delete_client_cert_on_vm|default(false)

  - block:
    - name: delete puppetlabs directory on VM
      file:
        path: '/etc/puppetlabs'
        state: absent
    - name: uninstall puppet agent on VM
      yum:
        name: puppet-agent
        state: absent
    become: "{{true if 'em7' in group_names else false}}"
    when: delete_client_cert_on_vm | default(false) | bool

  - block:
    - name: check if cleancert.sh exists
      stat:
        path: '/opt/puppet/qs_scripts/cleancert.sh'
      register: script_stat
      run_once: true
    - assert:
        that: script_stat.stat.exists
        fail_msg: 'Script to delete the certificates does not exist. Aborting!'
      run_once: true
    - name: delete the VM certificate
      shell: puppet cert clean {{'em7release.' if 'em7' in group_names else ''}}{{vm.name}}.{{sysconfig.domain_name}}
      args:
        chdir: '/usr/local/bin'
    when: delete_client_cert_on_server | default(false) | bool
    delegate_to: "{{groups['puppet']|first}}"
  tags: certificates
