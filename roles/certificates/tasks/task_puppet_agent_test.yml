---
# Tasks to perform puppet agent test
- block:
  - name: check if puppet agent test is already running and wait until it is done
    wait_for:
      path: '/opt/puppetlabs/puppet/cache/state/agent_catalog_run.lock'
      state: absent
      timeout: 1800
  - name: puppet agent test
    shell: /usr/local/bin/puppet agent --server {{puppet.fqdn}} --test
  delegate_to: "{{groups['puppet']|first}}"
  run_once: true
  tags: certificates
