---
# Tasks to perform puppet agent test
#- block:
#  - name: check if puppet agent test is already running on {{puppet.fqdn}} and wait until it is done
#    wait_for:
#      path: '/opt/puppetlabs/puppet/cache/state/agent_catalog_run.lock'
#      state: absent
#      timeout: 1800
#  - name: puppet agent test on {{puppet.fqdn}}
#    shell: /usr/local/bin/puppet agent --server {{puppet.fqdn}} --test
#  delegate_to: "{{groups['puppet']|first}}"
#  run_once: true
#  tags: certificates

- block:
  - name: check if puppet agent test is already running and wait until it is done
    wait_for:
      path: '/opt/puppetlabs/puppet/cache/state/agent_catalog_run.lock'
      state: absent
      timeout: 1800

  - name: check VM credentials
    shell: |
      ansible {{inventory_hostname}} -m ping -e "{ansible_ssh_pass: '{{ansible_ssh_pass}}'}" || echo 'Password changed'
    register: vm_creds2
    check_mode: no
    no_log: true
    delegate_to: 'localhost'
  - name: Update SSH password
    set_fact:
      ansible_ssh_pass: "{{pppp}}"
    no_log: true
    when:
      - vm_creds2.stdout is search('Password changed')
#  - meta: reset_connection

  - name: puppet agent test
    shell: /usr/local/bin/puppet agent --server {{puppet.fqdn}} --test
    register: puppet_agent
    async: 30
    poll: 0
    when: not ansible_check_mode
  - name: Wait for puppet agent test to start
    wait_for:
      path: '/opt/puppetlabs/puppet/cache/state/agent_catalog_run.lock'
      state: present
      timeout: 1800
    when: not ansible_check_mode

  - name: check VM credentials
    shell: |
      ansible {{inventory_hostname}} -m ping -e "{ansible_ssh_pass: '{{ansible_ssh_pass}}'}" || echo 'Password changed'
    register: vm_creds3
    no_log: true
    until: vm_creds3.stdout is search('Password changed')
    retries: 30
    delay: 60
    delegate_to: 'localhost'
    when:
      - ansible_ssh_pass != pppp
      - not ansible_check_mode
  - name: Update SSH password
    set_fact:
      ansible_ssh_pass: "{{pppp}}"
    no_log: true
    when:
      - ansible_ssh_pass != pppp
      - vm_creds3.stdout is search('Password changed')
      - not ansible_check_mode
#  - meta: reset_connection

  - name: Wait for puppet agent test to finish
    wait_for:
      path: '/opt/puppetlabs/puppet/cache/state/agent_catalog_run.lock'
      state: absent
      timeout: 1800
  when: "'em7' not in group_names"
  tags: certificates
