---
# Tasks to check passwordless ssh to relay
- block:
  - name: define passwordless_ssh_status
    ansible.builtin.set_fact:
      passwordless_ssh_status: "{{ user_expiry_status }}"
    when: user_expiry_status|default('') is search('does not exist')
  - block:
    - name: Check passwordless ssh to {{ rly_host }}
      ansible.builtin.shell: |
        $(which su) splunk -c 'ssh {{ hostvars[rly_host]['ansible_host'] }} exit'
      check_mode: no
      register: pwdlss_ssh
      ignore_errors: true
    - name: define passwordless_ssh status
      ansible.builtin.set_fact:
        passwordless_ssh_status: "{{ passwordless_ssh_status|default([]) + ['Passwordless SSH to ' + rly_host + ' is not working'] }}"
      when: pwdlss_ssh is failed
    when: user_expiry_status|default('') is not search('does not exist')
  tags: sanity
  