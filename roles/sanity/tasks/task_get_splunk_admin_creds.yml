---
# Tasks to get the splunk admin ceredentials
- block:
  - name: Get Encrypted Splunk admin credentials
    ansible.builtin.shell: |
      {{ 'sudo -S' if ansible_user != 'root' else '' }} head -1 /opt/splunk/etc/passwd {{ '<<< ' + ansible_ssh_pass if ansible_user != 'root' else '' }} | sed 's/^://' | awk -F '::' '{print $1}'
    register: reg_spl_admin_creds
    args:
      warn: no
    check_mode: no
    ignore_errors: yes
    no_log: yes
  - debug:
      msg: "{{ reg_spl_admin_creds|replace(ansible_ssh_pass, 'obfuscated') }}"
  - ansible.builtin.assert:
      that: reg_spl_admin_creds is succeeded
      fail_msg: 'Unable to read Splunk admin credentials'
  - name: define splunk admin password
    ansible.builtin.set_fact:
      spl_admin_creds: "{{ reg_spl_admin_creds.stdout }}"
  when:
    - "spl_status|default({'failed': true}) is succeeded"
    - inventory_hostname is search('spl')
  tags: sanity
