---
# Tasks to check the dataextractor configuration status
- block:
  - block:
    - name: get values from data extractor section {{ de_section }}
      ansible.builtin.shell: |
        $(which su) splunk -c '/opt/CSCO-CMS/DataExtractor/manageDataExtractorConfigs.sh -o list -s {{ de_section }}' | grep 'em7_db_ip_address\|em7_db_user_name'
      register: reg_de_vals
      check_mode: no
      ignore_errors: true
    - name: define cfged_em7db_ip_addr and cfged_em7db_user_name
      ansible.builtin.set_fact:
        cfged_em7db_ip_addr: "{{ reg_de_vals.stdout_lines[0].split('= ')|last if reg_de_vals.stdout_lines|length >= 1 else '' }}"
        cfged_em7db_user_name: "{{ reg_de_vals.stdout_lines[1].split('= ')|last if reg_de_vals.stdout_lines|length >= 2 else '' }}"
    - name: define rly_de_ip_status
      ansible.builtin.set_fact:
        rly_de_ip_status: "{{ rly_de_ip_status|default([]) + [de_section + ' EM7 DB IP Address is not correct or not configured as provided check ' + relay_conf_file + '. Got ' + cfged_em7db_ip_addr + ' instead of ' + actual_em7_db_vip] }}"
      when:
        - cfged_em7db_ip_addr != actual_em7_db_vip
    - name: define rly_de_username_status
      ansible.builtin.set_fact:
        rly_de_username_status: "{{ rly_de_username_status|default([]) + [de_section + ' EM7 DB Username is not correct or not configured as provided check ' + relay_conf_file + '. Got ' + cfged_em7db_user_name + ' instead of ' + actual_em7_db_user_name] }}"
      when:
        - cfged_em7db_user_name != actual_em7_db_user_name
    when: de_section is not search('EM7')
  - block:
    - name: get values from data extractor section {{ de_section }}
      ansible.builtin.shell: |
        $(which su) splunk -c '/opt/CSCO-CMS/DataExtractor/manageDataExtractorConfigs.sh -o list -s {{ de_section }}' | grep 'db_ip_address\|db_user_name'
      register: reg_de_vals
      check_mode: no
      ignore_errors: true
    - name: define cfged_em7db_ip_addr and cfged_em7db_user_name
      ansible.builtin.set_fact:
        cfged_em7db_ip_addr: "{{ reg_de_vals.stdout_lines[0].split('= ')|last if reg_de_vals.stdout_lines|length >= 1 else '' }}"
        cfged_em7db_user_name: "{{ reg_de_vals.stdout_lines[1].split('= ')|last if reg_de_vals.stdout_lines|length >= 2 else '' }}"
    - name: define rly_de_ip_status
      ansible.builtin.set_fact:
        rly_de_ip_status: "{{ rly_de_ip_status|default([]) + [de_section + ' DB IP Address is not correct or not configured as provided check ' + relay_conf_file + '. Got ' + cfged_em7db_ip_addr + ' instead of ' + actual_em7_db_vip] }}"
      when:
        - cfged_em7db_ip_addr != actual_em7_db_vip
    - name: define rly_de_username_status
      ansible.builtin.set_fact:
        rly_de_username_status: "{{ rly_de_username_status|default([]) + [de_section + ' DB Username is not correct or not configured as provided check ' + relay_conf_file + '. Got ' + cfged_em7db_user_name + ' instead of ' + actual_em7_db_user_name] }}"
      when:
        - cfged_em7db_user_name != actual_em7_db_user_name
    when: de_section is search('EM7')
  tags: sanity
  