---
# Tasks to check /etc/rsyslog.d/cmsp_em7.conf file content
- block:
  - name: Get IP addresses from /etc/rsyslog.d/cmsp_em7.conf
    ansible.builtin.shell: $(which cut) -d '@' -f2 /etc/rsyslog.d/cmsp_em7.conf | sort -u
    register: cmspem7_content
    check_mode: no
  - name: define cmspem7_status
    ansible.builtin.set_fact:
      cmspem7_status: 'The /etc/rsyslog.d/cmsp_em7.conf file is not found'
    when:
      - cmspem7_content.stderr is search('No such file or directory')
  - name: define cmspem7_status
    ansible.builtin.set_fact:
      cmspem7_status: 'More than one IP address is configured in /etc/rsyslog.d/cmsp_em7.conf'
    when:
      - cmspem7_content.stdout_lines | length > 1
  - name: define cmspem7_status
    ansible.builtin.set_fact:
      cmspem7_status: "vip.rly {{ customer.secondary.octets + '.52' if 'dr' in group_names else vip.rly }} address is not configured in /etc/rsyslog.d/cmsp_em7.conf"
    when:
      - cmspem7_content.stdout_lines | length == 1
      - cmspem7_content.stdout_lines[0] is not search(customer.secondary.octets + '.52' if 'dr' in group_names else vip.rly)
  tags: sanity