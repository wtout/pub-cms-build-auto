---
# Tasks to check the relay DBs
- block:
  - name: get list of databases
    ansible.builtin.shell: |
      mysql -u root -paQxkE4z2mKfqznUcTG5h --execute="SHOW DATABASES;"
    register: reg_list_dbs
    check_mode: no
  - name: define rly_dbs_status
    ansible.builtin.set_fact:
      rly_db_status: "{{ rly_db_list | difference(reg_list_dbs.stdout_lines | reject('search', '^Database$')) }} DB is missing"
    when: rly_db_list | difference(reg_list_dbs.stdout_lines | reject('search', '^Database$')) | length == 1
  - name: define rly_dbs_status
    ansible.builtin.set_fact:
      rly_db_status: "{{ rly_db_list | difference(reg_list_dbs.stdout_lines | reject('search', '^Database$')) }} DBs are missing"
    when: rly_db_list | difference(reg_list_dbs.stdout_lines | reject('search', '^Database$')) | length > 1
  - block:
    - name: get number of DataExtractor config rules
      ansible.builtin.shell: |
        mysql -u root -paQxkE4z2mKfqznUcTG5h --execute="select count(*) as DEConfigCount from DataExtractor.DataExtConfigurations;"
      register: reg_config_count
      check_mode: no
    - name: define rly_deconfigcount_status
      ansible.builtin.set_fact:
        rly_deconfigcount_status: "DEConfigCount is {{ reg_config_count.stdout_lines|last }} instead of 1131"
      when: reg_config_count.stdout_lines|last|int != 1131
    when: reg_list_dbs.stdout_lines | select('search', 'DataExtractor') | length == 1
  - block:
    - name: get number of relaydb syslog rules
      ansible.builtin.shell: |
        mysql -u root -paQxkE4z2mKfqznUcTG5h --execute="select count(*) as SyslogRulesCount from relaydb.syslog_rules;"
      register: reg_syslogrules_count
      check_mode: no
    - name: define rly_syslogrulescount_status
      ansible.builtin.set_fact:
        rly_syslogrulescount_status: "SyslogRulesCount is {{ reg_syslogrules_count.stdout_lines|last }} instead of 669"
      when: reg_syslogrules_count.stdout_lines|last|int != 669
    when: reg_list_dbs.stdout_lines | select('search', 'relaydb') | length == 1
  when:
    - service_status|default({})|select('search', 'mariadb is not found')|length == 0
    - service_status|default({})|select('search', 'mariadb is not active')|length == 0
  tags: sanity
