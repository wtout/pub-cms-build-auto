---
# Tasks to check Indexer Discovery status
- block:
  - include_tasks: task_get_splunk_admin_creds.yml
    when: spl_admin_creds is undefined
  - name: check status of indexer discovery
    ansible.builtin.shell: |
      $(which su) splunk -c '/opt/splunk/bin/splunk list forward-server -auth {{ spl_admin_creds }}'
    register: reg_ind_disc
    args:
      warn: no
    check_mode: no
    ignore_errors: yes
  - name: define indexer_discovery status
    ansible.builtin.set_fact:
      indexer_discovery_status: 'Admin password configured in /opt/splunk/etc/passwd is invalid'
    when:
      - reg_ind_disc is failed
      - reg_ind_disc.stderr == 'Login failed'
  - name: define indexer_discovery status
    ansible.builtin.set_fact:
      indexer_discovery_status: "{{ reg_ind_disc.stdout }}"
    when:
      - reg_ind_disc is succeeded
      - (reg_ind_disc.stdout_lines[1] is not search('None') and group_names | select('search', 'dr') | length > 0) or (reg_ind_disc.stdout_lines[1] is search('None') and group_names | select('search', 'dr') | length == 0)
  when:
    - "spl_status|default({'failed': true}) is succeeded"
    - inventory_hostname is search('spl')
  tags: sanity
