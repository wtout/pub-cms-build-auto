---
# Task file to remove hosts from cluster
- block:
  - name: Set host to maintenence mode
    vmware_maintenancemode:
      hostname: "{{ information.address }}"
      username: "{{ credentials.username }}"
      password: "{{ credentials.password }}"
      esxi_hostname: "{{ resource }}"
      state: present
      timeout: 3600
      validate_certs: no

  - name: Remove hosts from the '{{ hostvars[groups['vcenter'][0]]['information']['cluster'] }}' cluster
    vmware_host:
      hostname: "{{ information.address }}"
      username: "{{ credentials.username }}"
      password: "{{ credentials.password }}"
      datacenter: "{{ datacenter.name }}"
      folder: "{{ datacenter.name }}/host"
      esxi_hostname: "{{ resource }}"
      esxi_username: "{{ hostvars[groups['vcenter'][0]]['information']['hostuser'] }}"
      esxi_password: "{{ hostvars[groups['vcenter'][0]]['information']['hostpass'] }}"
      state: present
      validate_certs: no

  - name: Exit host maintenence mode
    vmware_maintenancemode:
      hostname: "{{ information.address }}"
      username: "{{ credentials.username }}"
      password: "{{ credentials.password }}"
      esxi_hostname: "{{ resource }}"
      state: absent
      timeout: 3600
      validate_certs: no
  delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"
  tags: ['infra_configure', 'infra_build_nodes', 'capcheck' ]
