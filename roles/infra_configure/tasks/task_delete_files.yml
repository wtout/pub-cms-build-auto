---
# tasks file to delete files on datastore
- block:
  - name: get list of directories or files from datastore
    uri:
      url: "https://{{ information.hostuser }}:{{ information.hostpass}}@{{ resname }}/folder?dcPath=ha-datacenter&dsName={{ dsname }}"
      return_content: yes
      validate_certs: no
    register: reg_content
    until: reg_content is succeeded
  - name: define datastore_content
    ansible.builtin.set_fact:
      datastore_content: "{{ datastore_content|default([]) | union([loop_item.split('/')|first]) }}"
    loop: "{{ reg_content.content.split('sas\">')[1:] }}"
    loop_control:
      loop_var: loop_item
      label: "{{ loop_item.split('/')|first }}"
  - name: Ensure {{ dsname }} is empty
    ansible.builtin.assert:
      that: datastore_content|default([]) == []
      fail_msg: "{{ ['Delete the following folders/files and rerun the automation:'] + datastore_content|default([]) }}"
  delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"
  tags: [ 'infra_configure', 'infra_build_nodes', 'capcheck' ]
