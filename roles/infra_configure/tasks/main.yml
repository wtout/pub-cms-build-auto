---
# tasks file for infra_configure
- block:
  - block:
    - name: Deploy HA infrastructure
      block:
      - name: Create HA datastores
        include_tasks:
          file: task_create_datastores.yml
          apply:
            vars:
              resource: "{{ resource_item }}"
              customer_prefix: "{{ customer.primary.name_prefix }}"
              count: "{{ count_idx }}"
        loop: "{{ resources[:2] }}"
        loop_control:
          loop_var: resource_item
          index_var: count_idx
      - name: Add HA vSwitches
        include_tasks: 
          file: task_add_vswitches.yml
          apply:
            vars:
              resource: "{{ resource_item }}"
        loop: "{{ resources[:2] }}"
        loop_control:
          loop_var: resource_item
      - name: Create HA portgroups
        include_tasks:
          file: task_create_portgroups.yml
          apply:
            vars:
              resource: "{{ resource_item }}"
              customer_prefix: "{{ customer.primary.name_prefix }}"
        loop: "{{ resources[:2] }}"
        loop_control:
          loop_var: resource_item
      - include_tasks: task_create_cluster.yml
      when:
        - ansible_play_batch | reject('search', 'dr|vcenter|bastion|puppet|nexus') | list | length >= 1

    - name: Deploy DR infrastructure
      block:
      - name: Create DR datastores
        include_tasks:
            file: task_create_datastores.yml
            apply:
              vars:
                resource: "{{ resource_item }}"
                customer_prefix: "{{ customer.secondary.name_prefix }}"
                count: 0
        loop: "{{ resources[2:] }}"
        loop_control:
          loop_var: resource_item
      - name: Add DR vSwitches
        include_tasks: 
          file: task_add_vswitches.yml
          apply:
            vars:
              resource: "{{ resource_item }}"
        loop: "{{ resources[2:] }}"
        loop_control:
          loop_var: resource_item
      - name: Create DR portgroups
        include_tasks:
          file: task_create_portgroups.yml
          apply:
            vars:
              resource: "{{ resource_item }}"
              customer_prefix: "{{ customer.secondary.name_prefix }}"
              count: 1
        loop: "{{ resources[2:] }}"
        loop_control:
          loop_var: resource_item
      - include_tasks: task_create_drcluster.yml
      when:
        - customer.disaster_recovery
        - ansible_play_batch | select('search', 'dr') | list | length >= 1
    when: configure_infra | default(false) | bool

  - block:
    - name: Rollback HA infrastructure
      block:
      - name: Delete HA datastores
        include_tasks:
          file: task_delete_datastores.yml
          apply:
            vars:
              resource: "{{ resource_item }}"
        loop: "{{ resources[:2] }}"
        loop_control:
          loop_var: resource_item
      - name: Delete HA vSwitches
        include_tasks:
          file: task_remove_vswitches.yml
          apply:
            vars:
              resource: "{{ resource_item }}"
        loop: "{{ resources[:2] }}"
        loop_control:
          loop_var: resource_item
      - name: Delete HA portgroups
        include_tasks:
          file: task_delete_portgroups.yml
          apply:
            vars:
              resource: "{{ resource_item }}"
        loop: "{{ resources[:2] }}"
        loop_control:
          loop_var: resource_item
      - include_tasks: task_delete_cluster.yml
      when:
        - ansible_play_batch | reject('search', 'dr|vcenter|bastion|puppet|nexus') | list | length >= 1

    - name: Rollback DR infrastructure
      block:
      - name: Delete DR datastores
        include_tasks:
          file: task_delete_datastores.yml
          apply:
            vars:
              resource: "{{ resource_item }}"
        loop: "{{ resources[2:] }}"
        loop_control:
          loop_var: resource_item
      - name: Delete DR vSwitches
        include_tasks:
          file: task_remove_vswitches.yml
          apply:
            vars:
              resource: "{{ resource_item }}"
        loop: "{{ resources[2:] }}"
        loop_control:
          loop_var: resource_item
      - name: Delete DR portgroups
        include_tasks:
          file: task_delete_portgroups.yml
          apply:
            vars:
              resource: "{{ resource_item }}"
        loop: "{{ resources[2:] }}"
        loop_control:
          loop_var: resource_item
      - include_tasks: task_delete_drcluster.yml
      when:
        - customer.disaster_recovery
        - ansible_play_batch | select('search', 'dr') | list | length >= 1
    when: rollback_infra | default(false) | bool
  tags: [ 'infra_configure', 'infra_build_nodes', 'capcheck' ]
  