---
# tasks file for infra_build_nodes
- block:
  - name: Deploy infrastructure
    block:
    - name: Create datastores
      block:
      - include_tasks:
          file: task_create_datastores.yml
          apply:
            vars:
              resource: "{{ resource_item }}"
              customer_prefix: "{{ customer.primary.name_prefix }}"
              count: "{{ count_idx }}"
        loop: "{{ resources[:2] }}"
        loop_control:
          loop_var: resource_item
          index_var: count_idx

      - include_tasks:
          file: task_create_datastores.yml
          apply:
            vars:
              resource: "{{ resources | last }}"
              customer_prefix: "{{ customer.secondary.name_prefix }}"
              count: 0
        when: customer.disaster_recovery

    - name: Add vSwitches
      include_tasks: 
        file: task_add_vswitches.yml
        apply:
          vars:
            resource: "{{ resource_item }}"
      loop: "{{ resources }}"
      loop_control:
        loop_var: resource_item

    - name: Create portgroups
      block:
      - include_tasks:
          file: task_create_portgroups.yml
          apply:
            vars:
              resource: "{{ resource_item }}"
              customer_prefix: "{{ customer.primary.name_prefix }}"
        loop: "{{ resources[:2] }}"
        loop_control:
          loop_var: resource_item

      - include_tasks:
          file: task_create_portgroups.yml
          apply:
            vars:
              resource: "{{ resources | last }}"
              customer_prefix: "{{ customer.secondary.name_prefix }}"
              count: 1
        when: customer.disaster_recovery
   
    - name: "{{ auto_dir + '/roles/vm_creation' }}: create cluster"
      include_role:
        name: "{{ auto_dir + '/roles/vm_creation' }}"
        tasks_from: task_create_cluster.yml
    when: configure_infra | default(false) | bool

  - block:
    - name: Rollback infrastructure
      include_tasks: task_rollback_infra.yml
      loop:
        - task_delete_datastores.yml
        - task_remove_vswitches.yml
        - task_delete_portgroups.yml
      loop_control:
        loop_var: rollback_task_item

    - name: "{{ auto_dir + '/roles/vm_creation' }}: delete cluster"
      include_role:
        name: "{{ auto_dir + '/roles/vm_creation' }}"
        tasks_from: task_delete_cluster.yml

    - name: "{{ auto_dir + '/roles/vm_creation' }}: delete drcluster"
      include_role:
        name: "{{ auto_dir + '/roles/vm_creation' }}"
        tasks_from: task_delete_drcluster.yml
      when: customer.disaster_recovery
    when: rollback_infra | default(false) | bool
  tags: [ 'infra_configure', 'infra_build_nodes', 'capcheck' ]