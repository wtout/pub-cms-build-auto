---
# tasks to delete cluster
- block:
  - name: Get host facts
    vmware_host_facts:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      esxi_hostname: "{{ item }}"
      validate_certs: no
    loop: "{{ hostvars[groups['vcenter'][0]]['information']['resources'][:2] }}"
    register: host_facts
    delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"

  - name: define host cluster
    set_fact:
      host_cluster: "{{ host_cluster|default({}) | combine( {loop_item.item: loop_item.ansible_facts.cluster} ) }}"
    loop: "{{ host_facts.results }}"
    loop_control:
      loop_var: loop_item

  - debug:
      msg:
        - "{{ host_cluster[host_item] }}"
    loop: "{{ hostvars[groups['vcenter'][0]]['information']['resources'][:2] }}"
    loop_control:
      loop_var: host_item
  tags: vm_creation

- name: Get VM info
  vmware_vm_info:
    hostname: "{{ host_item }}"
    username: "{{ hostvars[groups['vcenter'][0]]['information']['hostuser'] }}"
    password: "{{ hostvars[groups['vcenter'][0]]['information']['hostpass'] }}"
    vm_type: vm
    validate_certs: no
  loop: "{{ hostvars[groups['vcenter'][0]]['information']['resources'][:2] }}"
  loop_control:
    loop_var: host_item
  check_mode: no
  register: vm_info
  delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"
  tags: vm_creation

- name: define vm names list
  set_fact:
    vm_names: "{{ vm_names|default([]) + [host_item.virtual_machines | map(attribute='guest_name') | list] | flatten }}"
  loop: "{{ vm_info.results }}"
  loop_control:
    loop_var: host_item
  tags: vm_creation

- name: Get the guest_info
  vmware_guest_info:
    hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
    username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
    password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
    datacenter: "{{ datacenter.name }}"
    name: "{{ vm_item }}"
    validate_certs: no
  loop: "{{ vm_names }}"
  loop_control:
    loop_var: vm_item
  check_mode: no
  register: vmguest_info
  delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"
  tags: vm_creation

- name: define delete_cluster
  set_fact:
    delete_cluster: "{{ delete_cluster|default(true) and not vm_in_cluster }}"
#    delete_cluster: "{{delete_cluster|default(true) and not (vm_in_cluster and vm_on)}}"
  vars:
    vm_in_cluster: "{{ true if vm_item.instance.hw_cluster == hostvars[groups['vcenter'][0]]['information']['cluster'] else false }}"
#    vm_on: "{{true if vm_item.instance.hw_power_status|lower is search('poweredon') else false}}"
  loop: "{{ vmguest_info.results }}"
  loop_control:
    loop_var: vm_item
  tags: vm_creation

- name: Check if '{{ hostvars[groups['vcenter'][0]]['information']['cluster'] }}' cluster exists
  vmware_cluster_info:
    hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
    username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
    password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
    cluster_name: "{{ hostvars[groups['vcenter'][0]]['information']['cluster'] }}"
    validate_certs: no
  register: cluster_status
  delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != [''] and bastion.address != [''] and bastion.address != ['']) else 'localhost' }}"
  run_once: true
  ignore_errors: true
  when: delete_cluster|bool
  check_mode: no
  tags: vm_creation

- block:
  - name: Put hosts in maintenance mode
    vmware_maintenancemode:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      esxi_hostname: "{{ host_item }}"
      timeout: 3600
      state: present
      validate_certs: no
    loop: "{{ hostvars[groups['vcenter'][0]]['information']['resources'][:2] }}"
    loop_control:
      loop_var: host_item
    register: maint_mode
    when: host_cluster[host_item] == hostvars[groups['vcenter'][0]]['information']['cluster']

  - name: Move hosts out of the '{{ hostvars[groups['vcenter'][0]]['information']['cluster'] }}' cluster
    vmware_host:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      datacenter: "{{ datacenter.name }}"
      folder: "{{ datacenter.name }}/host"
      esxi_hostname: "{{ host_item }}"
      esxi_username: "{{ hostvars[groups['vcenter'][0]]['information']['hostuser'] }}"
      esxi_password: "{{ hostvars[groups['vcenter'][0]]['information']['hostpass'] }}"
      state: present
      validate_certs: no
    loop: "{{ hostvars[groups['vcenter'][0]]['information']['resources'][:2] }}"
    loop_control:
      loop_var: host_item
    register: move_hosts
    when: host_cluster[host_item] == hostvars[groups['vcenter'][0]]['information']['cluster']

  - name: Put hosts in normal mode
    vmware_maintenancemode:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      esxi_hostname: "{{ host_item }}"
      timeout: 3600
      state: absent
      validate_certs: no
    loop: "{{ hostvars[groups['vcenter'][0]]['information']['resources'][:2] }}"
    loop_control:
      loop_var: host_item
    register: normal_mode
    when: host_cluster[host_item] == hostvars[groups['vcenter'][0]]['information']['cluster']

  - name: Delete the '{{ hostvars[groups['vcenter'][0]]['information']['cluster'] }}' cluster
    vmware_cluster:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      datacenter: "{{ datacenter.name }}"
      cluster_name: "{{ hostvars[groups['vcenter'][0]]['information']['cluster'] }}"
      state: absent
      validate_certs: no
    register: cust_cluster
  delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != [''] and bastion.address != [''] and bastion.address != ['']) else 'localhost' }}"
  run_once: true
  when:
    - cluster_status is successful
    - delete_cluster|bool
  tags: vm_creation
