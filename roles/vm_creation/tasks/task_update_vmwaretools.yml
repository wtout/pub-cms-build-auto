---
# tasks to update VMWare tools on VM
- block:
  - name: Wait on VMware Tools to become available
    vmware_guest_tools_wait:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      validate_certs: false
      name: "{{ vm.name }}"
    delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"
  - name: wait 60 seconds for VM to become reachable
    wait_for_connection:
      timeout: 60
    when:
      - deploy_ovf is not changed
  when:
    - netconfig.gateway1 != ''
  tags: vm_creation

- block:
  # Intentionally gathering facts from the Ansible control machine or the bastion server in order to trick the vmware module with the correct platform information
  - name: Get remote host's facts
    setup:
      gather_subset: min
  - name: Upgrade VMWare Tools
    vmware_guest_tools_upgrade:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      name: "{{ vm.name }}"
      datacenter: "{{ datacenter.name }}"
      folder: "{{ datacenter.name }}/vm/{{ fldr_name }}"
      validate_certs: no
    register: vmt_upgrade
  delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"
  tags: vm_creation
