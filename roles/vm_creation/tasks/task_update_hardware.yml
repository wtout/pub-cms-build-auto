---
# tasks to update VM's hardware settings
- block:
  - name: Power-off VM
    vmware_guest:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      name: "{{ vm.name }}"
      datacenter: "{{ datacenter.name }}"
      cluster: "{{ hostvars[groups['vcenter'][0]]['information']['cluster'] }}"
      state: poweredoff
      validate_certs: no
  - name: Update VM hardware settings with one NIC
    vmware_guest:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      name: "{{ vm.name }}"
      datacenter: "{{ datacenter.name }}"
      cluster: "{{ hostvars[groups['vcenter'][0]]['information']['cluster'] }}"
      hardware:
        memory_mb: "{{ vm.memory|int * 1024 }}"
        num_cpus: "{{ vm.cpu|int }}"
      networks:
        - name: "{{ netconfig.network1 }}"
          ip: "{{ netconfig.ipaddress1 }}"
          netmask: "{{ netconfig.netmask1 }}"
          gateway: "{{ netconfig.gateway1 }}"
          device_type: vmxnet3
      customization:
        existing_vm: true
        dns_servers: "{{ sysconfig.dns_servers }}"
        domain: "{{ sysconfig.domain_name }}"
      validate_certs: no
      wait_for_customization: true
    register: vmguest_1net
    ignore_errors: true
    when:
      - ova_nets.stdout_lines|length == 1
      - "'rly' not in group_names"
      - "'lnxjmp' not in group_names"
  - name: Update VM hardware settings with two NICs
    vmware_guest:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      name: "{{ vm.name }}"
      datacenter: "{{ datacenter.name }}"
      cluster: "{{ hostvars[groups['vcenter'][0]]['information']['cluster'] }}"
      hardware:
        memory_mb: "{{ vm.memory|int * 1024 }}"
        num_cpus: "{{ vm.cpu|int }}"
      networks:
        - name: "{{ netconfig.network1 }}"
          ip: "{{ netconfig.ipaddress1 }}"
          netmask: "{{ netconfig.netmask1 }}"
          gateway: "{{ netconfig.gateway1 }}"
          device_type: vmxnet3
        - name: "{{ netconfig.network2 }}"
          ip: "{{ netconfig.ipaddress2 }}"
          netmask: "{{ netconfig.netmask2 }}"
          gateway: "{{ netconfig.gateway2 }}"
          device_type: vmxnet3
      customization:
        existing_vm: true
        dns_servers: "{{ sysconfig.dns_servers }}"
        domain: "{{ sysconfig.domain_name }}"
      validate_certs: no
      wait_for_customization: true
    register: vmguest_2net
    ignore_errors: true
    when:
      - ova_nets.stdout_lines|length == 2 or 'rly' in group_names or 'lnxjmp' in group_names
  - fail:
      msg: "{{ vmguest_1net.msg }}"
    when:
      - vmguest_1net is failed
      - "'Guest Customization is already pending' not in vmguest_1net.msg"
  - fail:
      msg: "{{ vmguest_2net.msg }}"
    when:
      - vmguest_2net is failed
      - "'Guest Customization is already pending' not in vmguest_2net.msg"
  delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"
  tags: vm_creation
