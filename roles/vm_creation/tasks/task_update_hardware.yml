---
# tasks to update VM's hardware settings
- block:
  - name: Power-off VM
    vmware_guest:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      name: "{{ vm.name }}"
      datacenter: "{{ hostvars[groups['vcenter'][0]]['information']['datacenter'] }}"
      cluster: "{{ hostvars[groups['vcenter'][0]]['information']['drcluster'] if 'dr' in group_names else hostvars[groups['vcenter'][0]]['information']['cluster'] }}"
      state: poweredoff
      validate_certs: no
  - name: Update VM hardware settings with one NIC
    vmware_guest:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      name: "{{ vm.name }}"
      datacenter: "{{ hostvars[groups['vcenter'][0]]['information']['datacenter'] }}"
      cluster: "{{ hostvars[groups['vcenter'][0]]['information']['drcluster'] if 'dr' in group_names else hostvars[groups['vcenter'][0]]['information']['cluster'] }}"
      hardware:
        memory_mb: "{{ vm.memory|int * 1024 }}"
        num_cpus: "{{ vm.cpu|int }}"
      networks:
        - name: "{{ netconfig.network1 }}"
          ip: "{{ netconfig.ipaddress1 }}"
          netmask: "{{ netconfig.netmask1 }}"
          gateway: "{{ netconfig.gateway1 }}"
          device_type: vmxnet3
          start_connected: true
          allow_guest_control: true
      customization:
        existing_vm: true
        dns_servers: "{{ sysconfig.dns_servers }}"
        domain: "{{ sysconfig.domain_name }}"
      validate_certs: no
      wait_for_customization: true
    register: vmguest_1net
    ignore_errors: true
    throttle: "{{ 5 if hostvars[groups['vcenter'][0]]['information']['datacenter'] == 'PAE-HX-DC' else 0 }}"
    when:
      - ova_nets.stdout_lines|length == 1
      - inventory_hostname is not regex('rly|lnxjmp')
  - name: Update VM hardware settings with two NICs
    vmware_guest:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      name: "{{ vm.name }}"
      datacenter: "{{ hostvars[groups['vcenter'][0]]['information']['datacenter'] }}"
      cluster: "{{ hostvars[groups['vcenter'][0]]['information']['drcluster'] if 'dr' in group_names else hostvars[groups['vcenter'][0]]['information']['cluster'] }}"
      hardware:
        memory_mb: "{{ vm.memory|int * 1024 }}"
        num_cpus: "{{ vm.cpu|int }}"
      networks:
        - name: "{{ netconfig.network1 }}"
          ip: "{{ netconfig.ipaddress1 }}"
          netmask: "{{ netconfig.netmask1 }}"
          gateway: "{{ netconfig.gateway1 }}"
          device_type: vmxnet3
          start_connected: true
          allow_guest_control: true
        - name: "{{ netconfig.network2 }}"
          ip: "{{ netconfig.ipaddress2 }}"
          netmask: "{{ netconfig.netmask2 }}"
          gateway: "{{ netconfig.gateway2 }}"
          device_type: vmxnet3
          start_connected: true
          allow_guest_control: true
      customization:
        existing_vm: true
        dns_servers: "{{ sysconfig.dns_servers }}"
        domain: "{{ sysconfig.domain_name }}"
      validate_certs: no
      wait_for_customization: true
    register: vmguest_2net
    ignore_errors: true
    throttle: "{{ 5 if hostvars[groups['vcenter'][0]]['information']['datacenter'] == 'PAE-HX-DC' else 0 }}"
    when:
      - ova_nets.stdout_lines|length == 2 or inventory_hostname is regex('rly|lnxjmp')
  - fail:
      msg: "{{ vmguest_1net.msg }}"
    when:
      - vmguest_1net is failed
      - "'Guest Customization is already pending' not in vmguest_1net.msg"
  - fail:
      msg: "{{ vmguest_2net.msg }}"
    when:
      - vmguest_2net is failed
      - "'Guest Customization is already pending' not in vmguest_2net.msg"
  delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"
  tags: vm_creation
