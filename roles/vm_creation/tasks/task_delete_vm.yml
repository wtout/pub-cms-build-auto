---
# tasks to delete VM
- block:
  - name: Define folder name
    set_fact:
      fldr_name: "{{hostvars[groups['vcenter'][0]]['information']['folder'] + '/' + customer.name if hostvars[groups['vcenter'][0]]['information']['deptype'] == 'h' else hostvars[groups['vcenter'][0]]['information']['folder']}}"
  - name: Delete VM
    vmware_guest:
      hostname: "{{hostvars[groups['vcenter'][0]]['information']['address']}}"
      username: "{{hostvars[groups['vcenter'][0]]['credentials']['username']}}"
      password: "{{hostvars[groups['vcenter'][0]]['credentials']['password']}}"
      name: "{{vm.name}}"
      datacenter: "{{datacenter.name}}"
      cluster: "{{hostvars[groups['vcenter'][0]]['information']['cluster']}}"
      folder: "{{datacenter.name}}/vm/{{fldr_name}}"
      state: absent
      force: yes
      validate_certs: no
  delegate_to: "{{groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != [''] and bastion.address != [''] and bastion.address != ['']) else 'localhost'}}"
  tags: vm_creation
