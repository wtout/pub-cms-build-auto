---
# tasks file for vm_creation
- block:
  - block:
    - name: remove VM's entry from the list of known hosts
      lineinfile:
        path: '~/.ssh/known_hosts'
        regexp: '^{{ ip_item }}'
        state: absent
        validate: '/bin/grep {{ ip_item }} %s'
      loop:
        - "{{ netconfig.ipaddress1 }}"
        - "{{ netconfig.ipaddress2 }}"
      loop_control:
        loop_var: ip_item
      when: ip_item != ''
      ignore_errors: true
      register: remove_host
    - name: purge known hosts file
      shell: cat /dev/null > ~/.ssh/known_hosts
      when: remove_host is failed
      run_once: true
    delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"

  - block:
    - block:
      - name: check VM reachable
        shell: ping {{ ansible_host }} -c 1
        register: vcr_vm_reachable
        ignore_errors: true
        check_mode: no
        delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"
      - block:
        - name: check VM credentials
          wait_for_connection:
            timeout: 6
          register: vcr_vm_creds
          ignore_errors: true
          check_mode: no
        - name: Update SSH password
          set_fact:
            ansible_ssh_pass: "{{ postppp }}"
          no_log: true
          when:
            - vcr_vm_creds is failed
            - vcr_vm_creds.msg is search('Invalid/incorrect username/password')
        when: vcr_vm_reachable is succeeded
      when:
        - ansible_ssh_pass != postppp
        - inventory_hostname is not search('em7')

    - include_tasks: task_create_vms.yml
    when: create_vms | default(false) | bool

  - include_tasks: task_rollback_vms.yml
    when: rollback_vms | default(false) | bool
  tags: vm_creation
