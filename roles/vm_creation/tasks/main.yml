---
# tasks file for vm_creation
- block:
  - block:
    - block:
      - name: check VM reachable
        shell: ping {{ansible_host}} -c 1
        register: vcr_vm_reachable
        ignore_errors: true
        check_mode: no
        delegate_to: localhost
      - block:
        - name: check VM credentials
          wait_for_connection:
            timeout: 6
          register: vcr_vm_creds
          ignore_errors: true
          check_mode: no
        - name: Update SSH password
          set_fact:
            ansible_ssh_pass: "{{postppp}}"
          no_log: true
          when:
            - vcr_vm_creds is failed
            - vcr_vm_creds.msg is search('Invalid/incorrect username/password')
        when: vcr_vm_reachable is succeeded
      when:
        - ansible_ssh_pass != postppp
        - "'em7' not in group_names"

    - include_tasks: task_create_vms.yml
    when: create_vms | default(false) | bool

  - include_tasks: task_rollback_vms.yml
    when: rollback_vms | default(false) | bool
  tags: vm_creation
