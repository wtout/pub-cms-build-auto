---
# tasks to determine whether or not the cluster is empty
- block:
  - name: Get the{{ ' DR' if (drvm_names is defined and vm_name in drvm_names) else '' }} guest_info
    vmware_guest_info:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      datacenter: "{{ hostvars[groups['vcenter'][0]]['information']['datacenter'] }}"
      name: "{{ vm_name }}"
      validate_certs: no
    check_mode: no
    register: vmguest_info
    delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"

  - name: define cluster_empty
    set_fact:
      cluster_empty: "{{ cluster_empty|default(true) and not vm_in_cluster }}"
  #    cluster_empty: "{{ cluster_empty|default(true) and not (vm_in_cluster and vm_on) }}"
    vars:
      clus_name: "{{ hostvars[groups['vcenter'][0]]['information'][('dr' if (drvm_names is defined and vm_name in drvm_names) else '') + 'cluster'] }}"
      vm_in_cluster: "{{ true if vmguest_info.instance.hw_cluster == clus_name else false }}"
  #    vm_on: "{{ true if vmguest_info.instance.hw_power_status|lower is search('poweredon') else false }}"
  when: cluster_empty | default(true)
  tags: vm_creation
