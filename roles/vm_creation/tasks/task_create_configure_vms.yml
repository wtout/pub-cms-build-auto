---
# Tasks to create and configure VM pairs
- block:
  - include_tasks: task_get_vm_datastore.yml
    when:
      - hostvars[groups[('dr' if 'dr' in group_names else '') + 'vcenter'][0]]['information']['datastore_cluster'] == ''
      - vm_ds is not defined or vm_ds == ''
  - include_tasks: task_deploy_ova.yml
  - include_tasks: task_update_disks.yml
  - include_tasks: task_recreate_vm.yml
    when: disk_rebuild|default(false)
  - include_tasks: task_update_hardware.yml
  - include_tasks: task_enable_root_login.yml
  - include_tasks: task_delete_gtw_from_network_file.yml
  - block:
    - include_tasks: task_recreate_vm.yml
    - include_tasks: task_update_hardware.yml
    - include_tasks: task_enable_root_login.yml
    - include_tasks: task_delete_gtw_from_network_file.yml
    - name: check if rebuild is still required
      ansible.builtin.assert:
        that:
          - not gtw_rebuild|default(false)
        fail_msg: 'Unable to delete the gateway from the network file successfully'
    when: gtw_rebuild|default(false)
  - include_tasks: task_update_default_route.yml
  - include_tasks: task_rename_interface.yml
  - include_tasks: task_update_vmwaretools.yml
  tags: vm_creation
