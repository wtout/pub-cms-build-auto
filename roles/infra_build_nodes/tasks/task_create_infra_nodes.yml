---
# Task file to create infra nodes
- block:
  - name: Define folder name
    set_fact:
      fldr_name: "{{ hostvars[groups['vcenter'][0]]['information']['folder'] + '/' + customer.name if hostvars[groups['vcenter'][0]]['information']['deptype'] == 'h' else hostvars[groups['vcenter'][0]]['information']['folder'] }}"

  - name: Define datastore
    include_tasks: task_get_onprem_datastore.yml
    when: not inventory_hostname is search('nexus')

  - name: Deploy Windows Jump Servers from OVA
    include_tasks: task_deploy_winjmp.yml
    when: inventory_hostname is search('winjmp')

  - name: Deploy Loadbalancers from OVA
    include_tasks: task_deploy_nsvpx_ova.yml
    when: inventory_hostname is search('nsvpx')

  - name: Deploy and configure CSRs
    block:
      - include_tasks: task_deploy_csr_ova.yml
      - include_tasks: task_configure_csr.yml
    when: inventory_hostname is search('csr')

  - name: Update Nexus switch
    include_tasks:
      file: task_update_nexus.yml
      apply:
        vars:
          dhcp_address: "{{ hostvars['csr01']['dhcp_address'] }}"
          dr_route: no
    when:
      - inventory_hostname is search('nexus')
      - hostvars['csr01']['dhcp_address'] != ''

  - name: Update Nexus switch (DR)
    include_tasks:
      file: task_update_nexus.yml
      apply:
        vars:
          dhcp_address: "{{ hostvars['drcsr01']['dhcp_address'] }}"
          dr_route: yes
    when:
      - customer.disaster_recovery
      - inventory_hostname is search('nexus')
      - hostvars['drcsr01']['dhcp_address'] != ''

  - name: Configure Netscalers
    include_tasks: task_configure_nsvpx.yml
    when: inventory_hostname is search('nsvpx')

  - name: Send Webex Teams notification with CSR/Netscaler serial numbers
    include_tasks: task_notify_teams.yml
    when: not inventory_hostname is search('nexus')

  - name: Configure Windows Jump Severs
    include_tasks: task_configure_winjmp.yml
    when: inventory_hostname is search('winjmp')
  tags: ['infra_build_nodes', 'never']