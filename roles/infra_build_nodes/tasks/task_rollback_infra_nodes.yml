---
# Task file to delete infra nodes
- block:
  - name: Delete VM
    community.vmware.vmware_guest:
      hostname: "{{ hostvars[groups[('dr' if 'dr' in group_names else '') + 'vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups[('dr' if 'dr' in group_names else '') + 'vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups[('dr' if 'dr' in group_names else '') + 'vcenter'][0]]['credentials']['password'] }}"
      name: "{{ vm.name }}"
      datacenter: "{{ hostvars[groups[('dr' if 'dr' in group_names else '') + 'vcenter'][0]]['information']['datacenter'] }}"
      state: absent
      force: yes
      validate_certs: no
    delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != [''] and bastion.address != [''] and bastion.address != ['']) else 'localhost' }}"
    when: not inventory_hostname is search('nexus')

  - name: Remove Netscaler key from known_hosts
    ansible.builtin.known_hosts:
      name: "{{ netconfig.nic1.ipaddress }}"
      path: "{{ lookup('env', 'HOME') }}/.ssh/known_hosts"
      state: absent
    become: "{{ 'yes' if host_os|lower is search('almalinux') else 'no' }}"
    delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"
    when: inventory_hostname is search('nsvpx')

  - include_tasks: task_rollback_nexus_update.yml
    when:
      - ansible_play_batch | select('search', 'csr') | list | length >= 1
      - inventory_hostname is search('nexus')
