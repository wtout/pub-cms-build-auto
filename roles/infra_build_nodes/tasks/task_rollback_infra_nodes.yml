---
# Task file to delete infra nodes
- block:
  # remove this line
  - pause:
  #
  - name: Delete VM
    vmware_guest:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      name: "{{ vm.name }}"
      datacenter: "{{ datacenter.name }}"
      state: absent
      force: yes
      validate_certs: no
    delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != [''] and bastion.address != [''] and bastion.address != ['']) else 'localhost' }}"
    when: not inventory_hostname is search('nexus')

  - block:
    - set_fact:
        ipaddress1: "{{ netconfig.ippool1[index|int - 1] if netconfig.ippool1 != [] else (customer.secondary.octets if inventory_hostname is search('dr') else customer.primary.octets) + '.' + netconfig.octetpool1[index|int - 1]|string if (netconfig.octetpool1 != [] and index|int <= netconfig.octetpool1|length) else '' }}"
      vars:
        index: "{{ inventory_hostname[-2:] }}"

    - name: Define Netscaler key
      shell: ssh-keyscan -t rsa {{ ipaddress1 }}
      register: host_key

    - name: Remove Netscaler 2 from known_hosts
      known_hosts:
        name: "{{ ipaddress1 }}"
        key: "{{ host_key.stdout }}"
        state: absent
    when: inventory_hostname is search('nsvpx')
    delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != [''] and bastion.address != [''] and bastion.address != ['']) else 'localhost' }}"

  - include_tasks: task_rollback_nexus_update.yml
    when: inventory_hostname is search('nexus')
  tags: ['infra_build_nodes', 'never']