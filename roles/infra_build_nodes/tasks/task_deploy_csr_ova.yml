---
# Task file to deploy CSR from ova
- name: Deploy CSRs from OVA
  community.vmware.vmware_deploy_ovf:
    hostname: "{{ hostvars[groups[('dr' if 'dr' in group_names else '') + 'vcenter'][0]]['information']['address'] }}"
    username: "{{ hostvars[groups[('dr' if 'dr' in group_names else '') + 'vcenter'][0]]['credentials']['username'] }}"
    password: "{{ hostvars[groups[('dr' if 'dr' in group_names else '') + 'vcenter'][0]]['credentials']['password'] }}"
    datacenter: "{{ hostvars[groups[('dr' if 'dr' in group_names else '') + 'vcenter'][0]]['information']['datacenter'] }}"
    disk_provisioning: "{{ vm.disk_provisioning if vm.disk_provisioning != '' else 'thin' if hostvars[groups[('dr' if 'dr' in group_names else '') + 'vcenter'][0]]['information']['datacenter'] is search('PAE-HX-DC|Staging|STG') else 'thick' }}"
    cluster: "{{ hostvars[groups[('dr' if 'dr' in group_names else '') + 'vcenter'][0]]['information']['cluster'] }}"
    datastore: "{{ hostvars[groups[('dr' if 'dr' in group_names else '') + 'vcenter'][0]]['information']['datastore_cluster'] if hostvars[groups[('dr' if 'dr' in group_names else '') + 'vcenter'][0]]['information']['datastore_cluster'] != '' else vm_ds }}"
    folder: "{{ hostvars[groups[('dr' if 'dr' in group_names else '') + 'vcenter'][0]]['information']['datacenter'] + '/vm' + ('/' + fldr_name if fldr_name != '' else '') }}"
    name: "{{ vm.name }}"
    networks: {}
    ova: "{{ ova_dir }}/{{ ova_names.csr }}"
    power_on: no
    wait: yes
    allow_duplicates: no
    validate_certs: no
    properties:
      com.cisco.csr1000v.login-username.1: "{{ credentials.username }}"
      com.cisco.csr1000v.login-password.1: "{{ credentials.password }}"
      com.cisco.csr1000v.enable-scp-server.1: 'True'
      com.cisco.csr1000v.enable-ssh-server.1: 'True'
      com.cisco.csr1000v.mgmt-ipv4-addr.1: 'dhcp'
      com.cisco.csr1000v.mgmt-ipv4-gateway.1: "dhcp"
      com.cisco.csr1000v.privilege-password.1 : "{{ credentials.password }}"
      com.cisco.csr1000v.hostname.1 : "{{ vm.name }}"
      com.cisco.csr1000v.domain-name.1 : "{{ sysconfig.secondary.domain_name if 'dr' in group_names else sysconfig.primary.domain_name }}"
  environment:
    http_proxy: ''
    https_proxy: ''
  delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"
