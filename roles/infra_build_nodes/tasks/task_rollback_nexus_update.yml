---
# Task file to remove CSR DHCP static route from Nexus switch
- block:
  - name: Define existing static IP routes
    nxos_command:
      commands: 'sh run | i route'
    register: static_routes_list

  - set_fact:
      existing_route: "{{ static_routes_list.stdout_lines[0] | select('search', customer.primary.octets) | list | first }}"
    when: static_routes_list.stdout_lines[0] | select('search', customer.primary.octets) | list != []

  - name: Remove DHCP entry from nexus
    nxos_command:
      commands:
        - configure terminal
        - "no {{ existing_route }}"
    when: existing_route is defined
      
  - block:
    - set_fact:
        existing_dr_route: "{{ static_routes_list.stdout_lines[0] | select('search', customer.secondary.octets) | list | first }}"
      when: static_routes_list.stdout_lines[0] | select('search', customer.secondary.octets) | list != []

    - name: Remove DHCP entry from nexus
      nxos_command:
        commands:
          - configure terminal
          - "no {{ existing_dr_route }}"
      when: existing_dr_route is defined
    when: customer.disaster_recovery
  tags: [ 'infra_build_nodes', 'infra_configure', 'never' ]
  