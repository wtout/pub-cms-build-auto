---
# tasks to validate vcenter credentials
- block:
  - block:
    - pip:
        name: PyVmomi
        extra_args: --user
    - name: Validate vcenter credentials
      vmware_about_facts:
        hostname: "{{hostvars[groups['vcenter'][0]]['vcenter']['address']}}"
        username: "{{hostvars[groups['vcenter'][0]]['vcenter']['username']}}"
        password: "{{hostvars[groups['vcenter'][0]]['vcenter']['password']}}"
        validate_certs: no
      register: vcenter_creds
      ignore_errors: true
    delegate_to: "{{groups['bastion'][0] if groups['bastion'] | length >= 1 else 'localhost'}}"
  - set_fact:
      abort_play: yes
      err_msg: "{{vcenter_host}}: {{vcenter_creds.msg}}"
    when: vcenter_creds is failed
  tags: always
