---
# tasks to validate vcenter credentials
- block:
  - name: Validate vcenter credentials
    vmware_about_info:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      validate_certs: no
    register: vcenter_creds
    ignore_errors: true
    delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"
    when: ansible_user != ''

  - set_fact:
      abort_play: yes
      err_msg: "{{ vcenter_host }}: {{ vcenter_creds.msg }}"
    when:
      - ansible_user == '' or vcenter_creds is failed
  tags: always
