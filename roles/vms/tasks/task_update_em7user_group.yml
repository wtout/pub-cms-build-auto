---
# Tasks to add the em7release user to the group wheel on the VM
- block:
  - name: Wait on VMware Tools to become available
    vmware_guest_tools_wait:
      hostname: "{{hostvars[groups['vcenter'][0]]['information']['address']}}"
      username: "{{hostvars[groups['vcenter'][0]]['credentials']['username']}}"
      password: "{{hostvars[groups['vcenter'][0]]['credentials']['password']}}"
      validate_certs: false
      name: "{{customer.name_prefix}}{{vm.name}}{{inventory_hostname[-2:]}}"
    delegate_to: "{{groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost'}}"
  - name: Pause for 10 seconds to ensure {{inventory_hostname}} finished booting
    wait_for:
      timeout: 10
    when: deploy_ovf is not changed
  - name: wait 60 seconds for {{inventory_hostname}} to become reachable
    wait_for_connection:
      timeout: 60
    when:
      - deploy_ovf is not changed
  when:
    - netconfig.gateway1 != ''
  tags: vms

- block:
  - name: Add the {{credentials.ssh_username}} user to the wheel group 
    vmware_vm_shell:
      hostname: "{{hostvars[groups['vcenter'][0]]['information']['address']}}"
      username: "{{hostvars[groups['vcenter'][0]]['credentials']['username']}}"
      password: "{{hostvars[groups['vcenter'][0]]['credentials']['password']}}"
      datacenter: "{{datacenter.name}}"
      validate_certs: false
      vm_id: "{{customer.name_prefix}}{{vm.name}}{{inventory_hostname[-2:]}}"
      vm_username: "{{ credentials.console_username }}"
      vm_password: "{{ credentials.console_password }}"
      vm_shell: '/sbin/usermod'
      vm_shell_args: "-aG wheel {{credentials.ssh_username}}"
      wait_for_process: true
  delegate_to: "{{groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost'}}"
  when: "'em7' in group_names"
  tags: vms
