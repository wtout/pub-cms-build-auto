---
# tasks file to create vms
- block:
  - name: get list of groups in play
    set_fact:
      play_group_list: "{{play_group_list|default([]) | union([hostvars[item]['group_names']]) | flatten | difference(['stack', 'em7', 'splunk', 'infra', 'vcenter'])}}"
    loop: "{{ansible_play_hosts}}"
    run_once: true
  - include_tasks: task_create_folder.yml
    when:
      - hostvars[groups['vcenter'][0]]['information']['deptype'] == 'h'
    run_once: true
  - include_tasks: task_create_cluster.yml
    when:
      - hostvars[groups['vcenter'][0]]['information']['deptype'] == 'a'
    run_once: true
  - include_tasks:
      file: task_create_vm_pair.yml
      apply:
        vars:
          vm_group: "{{item}}"
    loop: "{{play_group_list}}"
    when: inventory_hostname in groups[item]

  - include_tasks: task_update_vmwaretools.yml
  - include_tasks: task_configure_snmp.yml
  - include_tasks: task_update_chrony.yml
  - include_tasks: task_update_repo.yml
  - include_tasks: task_update_puppet_data_file.yml
  - include_tasks: task_update_hosts_file.yml
  - include_tasks: task_update_silo_file.yml
  - include_tasks: task_update_siloconf_file.yml
  - include_tasks: task_update_drop_file.yml
  - include_tasks: task_update_em7vg_files.yml
  - include_tasks: task_update_corosync_file.yml
  - include_tasks: task_update_drbd_res_file.yml
  - name: flush handlers
    meta: flush_handlers
  - include_tasks: task_update_cluster_vip.yml
  - include_tasks: task_update_dbconns_file.yml
#  - include_tasks: task_get_em7_license.yml

  tags: vms
