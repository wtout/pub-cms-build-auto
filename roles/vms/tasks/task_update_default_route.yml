---
# Tasks to configure the default route on the VM
- block:
  - name: Wait on VMware Tools to become available
    vmware_guest_tools_wait:
      hostname: "{{hostvars[groups['vcenter'][0]]['information']['address']}}"
      username: "{{hostvars[groups['vcenter'][0]]['credentials']['username']}}"
      password: "{{hostvars[groups['vcenter'][0]]['credentials']['password']}}"
      validate_certs: false
      name: "{{customer.name_prefix}}{{vm.name}}{{inventory_hostname[-2:]}}"
  - name: Pause for 30 seconds to ensure VM finished booting
    wait_for:
      timeout: 30
    when: deploy_ovf is not changed
  - name: copy default route file locally
    template:
      src: "{{playbook_dir}}/roles/vms/templates/route-ens160.tmpl"
      dest: "/var/tmp/{{customer.name_prefix}}-route-ens160"
    run_once: true
  - name: copy default route file to VM
    vmware_guest_file_operation:
      hostname: "{{hostvars[groups['vcenter'][0]]['information']['address']}}"
      username: "{{hostvars[groups['vcenter'][0]]['credentials']['username']}}"
      password: "{{hostvars[groups['vcenter'][0]]['credentials']['password']}}"
      datacenter: "{{datacenter.name}}"
      validate_certs: false
      vm_id: "{{customer.name_prefix}}{{vm.name}}{{inventory_hostname[-2:]}}"
      vm_username: "{{ credentials.console_username }}"
      vm_password: "{{ credentials.console_password }}"
      copy:
          src: "/var/tmp/{{customer.name_prefix}}-route-ens160"
          dest: "/etc/sysconfig/network-scripts/route-ens160"
          overwrite: false
  - name: restart the network on the VM
    vmware_vm_shell:
      hostname: "{{hostvars[groups['vcenter'][0]]['information']['address']}}"
      username: "{{hostvars[groups['vcenter'][0]]['credentials']['username']}}"
      password: "{{hostvars[groups['vcenter'][0]]['credentials']['password']}}"
      datacenter: "{{datacenter.name}}"
      validate_certs: false
      vm_id: "{{customer.name_prefix}}{{vm.name}}{{inventory_hostname[-2:]}}"
      vm_username: "{{ credentials.console_username }}"
      vm_password: "{{ credentials.console_password }}"
      vm_shell: '/bin/systemctl'
      vm_shell_args: 'restart network'
      wait_for_process: true
  - name: delete default route file locally
    file:
      path: "/var/tmp/{{customer.name_prefix}}-route-ens160"
      state: absent
    run_once: true
  when: netconfig.gateway1 == ''
  delegate_to: "{{groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost'}}"
  tags: vms
