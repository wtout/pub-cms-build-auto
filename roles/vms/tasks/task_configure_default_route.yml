---
# Tasks to configure the default route on the VM
- block:
  - name: Ensure VM is powered on
    vmware_guest_tools_wait:
      hostname: "{{hostvars[groups['vcenter'][0]]['information']['address']}}"
      username: "{{hostvars[groups['vcenter'][0]]['credentials']['username']}}"
      password: "{{hostvars[groups['vcenter'][0]]['credentials']['password']}}"
      validate_certs: false
      name: "{{customer.name_prefix}}{{vm.name}}{{inventory_hostname | regex_replace('[^\\.]+([0-9][0-9])$', '\\1')}}"
  - name: copy default route file locally
    template:
      src: "{{playbook_dir}}/roles/vms/templates/route-ens160"
      dest: "/var/tmp/{{customer.name_prefix}}-route-ens160"
    run_once: true
  - name: copy default route file to VM
    vmware_guest_file_operation:
      hostname: "{{hostvars[groups['vcenter'][0]]['information']['address']}}"
      username: "{{hostvars[groups['vcenter'][0]]['credentials']['username']}}"
      password: "{{hostvars[groups['vcenter'][0]]['credentials']['password']}}"
      datacenter: "{{datacenter.name}}"
      validate_certs: false
      vm_id: "{{customer.name_prefix}}{{vm.name}}{{inventory_hostname | regex_replace('[^\\.]+([0-9][0-9])$', '\\1')}}"
      vm_username: "{{ credentials.username }}"
      vm_password: "{{ credentials.password }}"
      copy:
          src: "/var/tmp/{{customer.name_prefix}}-route-ens160"
          dest: "/etc/sysconfig/network-scripts/route-ens160"
          overwrite: false
  - name: restart the network on the VM
    vmware_vm_shell:
        hostname: "{{hostvars[groups['vcenter'][0]]['information']['address']}}"
        username: "{{hostvars[groups['vcenter'][0]]['credentials']['username']}}"
        password: "{{hostvars[groups['vcenter'][0]]['credentials']['password']}}"
        datacenter: "{{datacenter.name}}"
        validate_certs: false
        vm_id: "{{customer.name_prefix}}{{vm.name}}{{inventory_hostname | regex_replace('[^\\.]+([0-9][0-9])$', '\\1')}}"
        vm_username: "{{ credentials.username }}"
        vm_password: "{{ credentials.password }}"
        vm_shell: /bin/systemctl
        vm_shell_args: "restart network"
        wait_for_process: true
  - name: delete default route file locally
    file:
      path: "/var/tmp/{{customer.name_prefix}}-route-ens160"
      state: absent
    run_once: true
  tags: vms
