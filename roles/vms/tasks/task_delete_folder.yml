---
# Tasks to delete the VM folder
- block:
  - name: Delete the '{{hostvars[groups['vcenter'][0]]['information']['folder']}}/{{customer.name}}' folder
    vcenter_folder:
      hostname: "{{hostvars[groups['vcenter'][0]]['information']['address']}}"
      username: "{{hostvars[groups['vcenter'][0]]['credentials']['username']}}"
      password: "{{hostvars[groups['vcenter'][0]]['credentials']['password']}}"
      datacenter_name: "{{datacenter.name}}"
      folder_name: "{{customer.name}}"
      folder_type: vm
      parent_folder: "{{hostvars[groups['vcenter'][0]]['information']['folder']}}"
      state: absent
      validate_certs: no
    register: cust_folder
    ignore_errors: true
  - debug:
      msg: "The folder '{{hostvars[groups['vcenter'][0]]['information']['folder']}}/{{customer.name}}' cannot be deleted because it is not empty"
    when:
      - cust_folder is failed
      - "'The attempted operation cannot be performed in the current state (Powered on)' in cust_folder.msg"
  - fail:
      msg: "Failed to delete the folder '{{hostvars[groups['vcenter'][0]]['information']['folder']}}/{{customer.name}}'"
    when:
      - cust_folder is failed
      - "'The attempted operation cannot be performed in the current state (Powered on)' not in cust_folder.msg"
  delegate_to: "{{groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost'}}"
  tags: vms
