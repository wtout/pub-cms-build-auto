---
# tasks to delete VM
- debug:
    msg:
      - "{{vm.name}}{{inventory_hostname | regex_replace('[^\\.]+([0-9][0-9])$', '\\1')}}"
  tags: vms

- name: Delete VM
  vmware_guest:
    hostname: "{{hostvars[groups['vcenter'][0]]['information']['address']}}"
    username: "{{hostvars[groups['vcenter'][0]]['credentials']['username']}}"
    password: "{{hostvars[groups['vcenter'][0]]['credentials']['password']}}"
    name: "{{vm.name}}{{inventory_hostname | regex_replace('[^\\.]+([0-9][0-9])$', '\\1')}}"
    datacenter: "{{datacenter.name}}"
    cluster: "{{hostvars[groups['vcenter'][0]]['information']['cluster']}}"
    folder: "{{datacenter.name}}/vm/{{hostvars[groups['vcenter'][0]]['information']['folder']}}"
    resource_pool: "{{\"hostvars[groups['vcenter'][0]]['information']['resources']\"}}"
    state: absent
    force: yes
    validate_certs: no
  delegate_to: "{{groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != []) else 'localhost'}}"
  tags: vms
