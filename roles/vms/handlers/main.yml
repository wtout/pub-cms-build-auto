---
# handlers file for vms
- name: expand disk0
  parted:
    device: /dev/sda
    unit: MiB
    number: 2
  become: "{{true if 'em7' in group_names else false}}"
  register: parted_info
  changed_when: parted_info is succeeded
  notify: define parted_start
  tags: vms

- name: define parted_start
  set_fact:
    parted_start: "{{task_item.begin | default(0)}}"
  loop: "{{parted_info.partitions}}"
  loop_control:
    loop_var: task_item
  when: task_item.num == 2
  changed_when: parted_info is succeeded
  notify: delete old disk0 partition
  tags: vms

- name: delete old disk0 partition
  parted:
    device: /dev/sda
    number: 2
    state: absent
  become: "{{true if 'em7' in group_names else false}}"
  notify: create new disk0 partition
  tags: vms

- name: create new disk0 partition
  parted:
    device: /dev/sda
    number: 2
    flags: [ lvm ]
    part_start: "{{parted_start}}MiB"
    state: present
  become: "{{true if 'em7' in group_names else false}}"
  notify: reboot vm
  tags: vms

- name: reboot vm
  reboot:
    post_reboot_delay: 10
    reboot_timeout: 60
  become: "{{true if 'em7' in group_names else false}}"
  tags: vms

- name: expand disk1
  shell: partprobe; pvresize /dev/sdb; lvresize -l +100%FREE -r /dev/mapper/vgroup2-opt
  become: "{{true if 'em7' in group_names else false}}"
  tags: vms

- name: expand disk2
  shell: |
    parted --script /dev/sdc mklabel gpt mkpart vgroup3 0% 100% set 1 lvm on
    pvcreate /dev/sdc1
    vgcreate vgroup3 /dev/sdc1
    lvcreate -l100%FREE -n data01 /dev/vgroup3
  become: "{{true if 'em7' in group_names else false}}"
  notify: create disk2 filesystem
  tags: vms

- name: create disk2 filesystem
  filesystem:
    fstype: ext4
    device: /dev/vgroup3/data01
  become: "{{true if 'em7' in group_names else false}}"
  notify: set data01 mount points
  tags: vms

- name: set data01 mount points
  mount:
    name: /data01
    src: /dev/mapper/vgroup3-data01
    fstype: ext4
    opts: defaults
    state: mounted
    dump: '1'
    passno: '2'
  become: "{{true if 'em7' in group_names else false}}"
  notify: set permissions and ownership of /data01
  tags: vms

- name: set permissions and ownership of /data01
  file:
    path: /data01
    state: directory
    mode: 0755
    owner: root
    group: root
  become: "{{true if 'em7' in group_names else false}}"
  tags: vms

- name: expand disk3
  shell: |
    parted --script /dev/sdd mklabel gpt mkpart vgroup4 0% 100% set 1 lvm on
    pvcreate /dev/sdd1
    vgcreate vgroup4 /dev/sdd1
    lvcreate -l100%FREE -n data02 /dev/vgroup4
  become: "{{true if 'em7' in group_names else false}}"
  notify: create disk3 filesystem
  tags: vms

- name: create disk3 filesystem
  filesystem:
    fstype: ext4
    device: /dev/vgroup4/data02
  become: "{{true if 'em7' in group_names else false}}"
  notify: set data02 mount points
  tags: vms

- name: set data02 mount points
  mount:
    name: /data02
    src: /dev/mapper/vgroup4-data02
    fstype: ext4
    opts: defaults
    state: mounted
    dump: '1'
    passno: '2'
  become: "{{true if 'em7' in group_names else false}}"
  notify: set permissions and ownership of /data02
  tags: vms

- name: set permissions and ownership of /data02
  file:
    path: /data02
    state: directory
    mode: 0755
    owner: root
    group: root
  become: "{{true if 'em7' in group_names else false}}"
  tags: vms

- name: restart chrony
  service:
    name: chronyd
    state: restarted
  become: "{{true if 'em7' in group_names else false}}"
  tags: vms

- name: restart snmpd service
  service:
    name: 'snmpd'
    state: restarted
  become: "{{true if 'em7' in group_names else false}}"
  tags: vms

- name: restart drbd
  service:
    name: 'drbd'
    state: restarted
  become: "{{true if 'em7' in group_names else false}}"
  notify:
    - mount drbd1
    - start mysql
    - start em7
    - restart pacemaker
    - restart corosync
  tags: vms

- name: mount drbd1
  shell: |
    drbd-overview | grep -i secondary/secondary && /sbin/drbdadm primary r0
    mount /dev/drbd1 /data.local/db
    df | grep /drbd1
  become: "{{true if 'em7' in group_names else false}}"
  when: inventory_hostname is search('01')
  tags: vms

- name: start mysql
  service:
    name: mysql
    state: started
  become: "{{true if 'em7' in group_names else false}}"
  when: inventory_hostname is search('01')
  tags: vms

- name: start em7
  service:
    name: em7
    state: started
  become: "{{true if 'em7' in group_names else false}}"
  when: inventory_hostname is search('01')
  tags: vms

- name: restart pacemaker
  service:
    name: pacemaker
    state: restarted
  become: "{{true if 'em7' in group_names else false}}"
  tags: vms

- name: restart corosync
  service:
    name: corosync
    state: restarted
  become: "{{true if 'em7' in group_names else false}}"
  tags: vms

- name: start nfs
  service:
    name: nfs
    state: started
  become: "{{true if 'em7' in group_names else false}}"
  tags: vms

