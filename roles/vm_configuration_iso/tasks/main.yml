---
# tasks file for vm_configuration
- block:
#  - name: check VM reachable
#    shell: ping {{ ansible_host }} -c 1
#    register: vco_vm_reachable
#    ignore_errors: true
#    check_mode: no
#    delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"
  - block:
    - name: check VM credentials
      wait_for_connection:
        timeout: 3
      register: vco_vm_creds
      ignore_errors: true
      check_mode: no
    - block:
      - name: Update SSH credentials
        set_fact:
          ansible_user: "{{ vm_svc_user }}"
          ansible_ssh_pass: "{{ vm_svc_pass }}"
          ansible_become_pass: "{{ vm_svc_pass }}"
        no_log: true
      - name: check updated VM credentials
        wait_for_connection:
          timeout: 3
        register: vco_vm_creds2
        check_mode: no
        ignore_errors: true
      - name: define creds_status
        ansible.builtin.set_fact:
          creds_status: 'The VM credentials are invalid'
        when: vco_vm_creds2 is failed
      when:
        - vco_vm_creds is failed
        - vco_vm_creds.msg is search('Invalid/incorrect username/password')

    - include_tasks: task_configure_vms.yml
#    when: vco_vm_reachable is succeeded
  when: configure_vms_iso | default(false) | bool
  tags: vm_configuration
