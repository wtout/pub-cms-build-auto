---
# tasks to restore /etc/silo.conf on EM7 VM
- block:
  - name: check primary DB credentials
    wait_for_connection:
      timeout: 15
    delegate_to: "{{ groups['em7db']|first }}"
    register: primarydb_connection_status1
    check_mode: no
    ignore_errors: true

  - name: Update dbpasswd in silo.conf on DR VM
    replace:
      path: /etc/silo.conf
      regexp: '^({{ task_item.param }}) (.*)$'
      replace: '\g<1> {{ task_item.value }}'
    loop:
      - { param: 'dbpasswd =', value: "{{ vars[('STG' if datacenter.primary.name == 'RTP-Staging' else '') + 'EM7DBPPP_PASS'] }}" }
    loop_control:
      loop_var: task_item
    no_log: true
    when:
      - primarydb_connection_status1 is failed or hostvars[groups['em7db']|first]['ansible_ssh_pass'] == postppp

  - name: Restore dbpasswd in silo.conf on DR VM
    replace:
      path: /etc/silo.conf
      regexp: '^({{ task_item.param }}) {{ task_item.regexp }}$'
      replace: '\g<1> {{ task_item.value }}'
    loop:
      - { param: 'dbpasswd =', regexp: "{{ vars[('STG' if datacenter.primary.name == 'RTP-Staging' else '') + 'EM7DBPPP_PASS'] }}", value: 'em7admin' }
    loop_control:
      loop_var: task_item
    no_log: true
    when:
      - primarydb_connection_status1 is succeeded and hostvars[groups['em7db']|first]['ansible_ssh_pass'] == preppp

  when:
    - (inventory_hostname is regex('drem7(prt|db)') and customer.release is search('9.2')) or (inventory_hostname is search('drem7prt') and customer.release is not search('9.2'))
  become: "{{ true if inventory_hostname is search('em7') else false }}"
  tags: vm_configuration
