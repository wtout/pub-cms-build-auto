---
# Tasks to set the Max Connections
- block:
  - name: set max connections in db
    ansible.builtin.shell:
      cmd: silo_mysql -e "SET GLOBAL max_connections = 1000;"
    register: set_mc_db
    when:
      - inventory_hostname is search('01')

  - include_tasks:
      file: task_update_setting.yml
      apply:
        vars:
          fname: "{{ file_item }}"
          varname: 'max_connections'
          varvalue: '1000'
          instanza: '[mysqld]'
    loop:
      - /etc/my.cnf.d/silo_mysql.cnf
      - /etc/siteconfig/mysql.siteconfig
    loop_control:
      loop_var: file_item

  when: (groups['em7']|length > 1 and inventory_hostname is search('em7db')) or (groups['em7']|length == 1 and inventory_hostname is search('em7'))
  tags: vm_configuration
