---
# tasks to update chrony.conf on VM
- block:
  - name: Remove bad time server from the chrony config file
    lineinfile:
      path: "{{ chrony_file }}"
      regexp: '^server [0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$'
      state: absent
  - name: Comment out the default time servers in the chrony config file
    replace:
      path: "{{ chrony_file }}"
      regexp: "{{ line_item }}"
      replace: '#\g<1>'
    loop:
      - '^(include.*chrony\.d.*)$'
      - '^(server .*org iburst)$'
    loop_control:
      loop_var: line_item
  - name: Add the local time server to the chrony config file
    lineinfile:
      path: "{{ chrony_file }}"
      line: "server {{ sysconfig.secondary_ntp_server if 'dr' in group_names else sysconfig.ntp_server }} iburst"
      insertafter: '^# Please consider.*$'
    notify: restart chrony
  become: "{{ true if inventory_hostname is search('em7') else false }}"
  tags: vm_configuration
