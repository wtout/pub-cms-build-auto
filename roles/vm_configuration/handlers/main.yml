---
# handlers file for vm_configuration
- name: restart chrony
  systemd:
    name: chronyd
    state: restarted
    daemon_reload: yes
  become: "{{ true if inventory_hostname is search('em7') else false }}"
  tags: vm_configuration

- name: yum clean all
  command: yum clean all
  args:
    warn: no
  become: "{{ true if inventory_hostname is search('em7') else false }}"
  tags: vm_configuration

- name: restart snmpd service
  systemd:
    name: snmpd
    state: restarted
    daemon_reload: yes
  become: "{{ true if inventory_hostname is search('em7') else false }}"
  tags: vm_configuration

- name: restart drbd
  systemd:
    name: drbd
    state: restarted
    daemon_reload: yes
  become: "{{ true if inventory_hostname is search('em7') else false }}"
  notify:
    - mount drbd1
    - start mysql
    - start em7
    - restart pacemaker
    - restart corosync
  when: "'dr' not in group_names"
  tags: vm_configuration

- name: mount drbd1
  shell: |
    {{ 'drbd-overview | grep -i secondary/secondary' if customer.release is not search('9.2') else '/sbin/drbdadm status | grep -i r0 | cut -d ":" -f2 | grep -i secondary && /sbin/drbdadm status | grep -i "peer " | cut -d ":" -f2 | grep -i secondary' }} && /sbin/drbdadm primary r0
    mount /dev/drbd1 /data.local/db
    df | grep /drbd1
  become: "{{ true if inventory_hostname is search('em7') else false }}"
  register: drbd1_status
  until: drbd1_status.stdout is search('drbd1')
  retries: 3
  when:
    - not ansible_check_mode
    - inventory_hostname is search('01')
  tags: vm_configuration

- name: start mysql
  systemd:
    name: mysql
    state: started
  become: "{{ true if inventory_hostname is search('em7') else false }}"
  when: inventory_hostname is search('01')
  tags: vm_configuration

- name: start em7
  systemd:
    name: em7
    state: started
  become: "{{ true if inventory_hostname is search('em7') else false }}"
  when: inventory_hostname is search('01')
  tags: vm_configuration

- name: restart pacemaker
  systemd:
    name: pacemaker
    state: restarted
    daemon_reload: yes
  become: "{{ true if inventory_hostname is search('em7') else false }}"
  register: pacemaker_status
  until: pacemaker_status is succeeded
  tags: vm_configuration

- name: restart corosync
  systemd:
    name: corosync
    state: restarted
    daemon_reload: yes
  become: "{{ true if inventory_hostname is search('em7') else false }}"
  tags: vm_configuration

- name: start nfs
  systemd:
    name: nfs
    state: started
  become: "{{ true if inventory_hostname is search('em7') else false }}"
  tags: vm_configuration

