---
# tasks file for create_vm
- block:
  - include_tasks: task_get_vm_ip.yml

  - name: get list of groups in stack
    set_fact:
      group_list: "{{group_list|default([]) | union([hostvars[item]['group_names']]) | flatten | difference(['stack', 'em7', 'splunk'])}}"
    loop: "{{groups['stack']}}"
    run_once: true
  - debug:
      msg: "{{group_list}}"
    run_once: true

  - include_tasks:
      file: task_assign_vm_datastore.yml
      apply:
        vars:
          stack_group: "{{item}}"
    loop: "{{group_list}}"
    when: inventory_hostname in groups[item]

  when: create_vm | default(false) | bool
  tags: create_vm
