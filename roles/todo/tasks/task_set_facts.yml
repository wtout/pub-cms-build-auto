---
- name: define configure_ssh_keys
  set_fact:
    configure_ssh_keys: true
  when:
    - deploy | default(false) | bool
    - inventory_hostname in groups['bastion']
    - bastion.address != []
    - bastion.address != ['']
  tags: ssh_keys

- name: define rollback_ssh_keys
  set_fact:
    rollback_ssh_keys: true
  when:
    - rollback | default(false) | bool
    - inventory_hostname in groups['bastion']
    - bastion.address != []
    - bastion.address != ['']
  tags: ssh_keys

- name: define add_dns_records
  set_fact:
    add_dns_records: true
  when: 
    - deploy | default(false) | bool
    - inventory_hostname in groups['stack'] or (customer.disaster_recovery and inventory_hostname in groups['dr'])
  tags: [ 'infra_dns_records', 'infra_configure', 'never' ]

- name: define rollback_dns_records
  set_fact:
    rollback_dns_records: true
  when: 
    - rollback | default(false) | bool
    - inventory_hostname in groups['stack'] or (customer.disaster_recovery and inventory_hostname in groups['dr'])
  tags: [ 'infra_dns_records', 'infra_configure', 'never' ]

- name: define configure_infra
  set_fact:
    configure_infra: true
  when:
    - deploy | default(false) | bool
    - inventory_hostname in groups['vcenter']
  tags: [ 'infra_configure', 'infra_build_nodes', 'never' ]

- name: define rollback_infra
  set_fact:
    rollback_infra: true
  when:
    - rollback | default(false) | bool
    - inventory_hostname in groups['vcenter']
  tags: [ 'infra_configure', 'never' ]

- name: define capcheck
  set_fact:
    capcheck: true
  when:
    - deploy | default(false) | bool
    - inventory_hostname in groups['vcenter']
  tags: [ 'capcheck', 'vm_creation', 'infra_build_nodes' ]
  
- name: define build_infra_nodes
  set_fact:
    build_infra_nodes: true
  when:
    - deploy | default(false) | bool
    - inventory_hostname in groups['infra'] or inventory_hostname in groups['nexus'] or (customer.disaster_recovery and inventory_hostname in groups['drinfra'])
  tags: [ 'infra_build_nodes', 'never' ]

- name: define rollback_infra_nodes
  set_fact:
    rollback_infra_nodes: true
  when:
    - rollback | default(false) | bool
    - inventory_hostname in groups['infra'] or inventory_hostname in groups['nexus'] or (customer.disaster_recovery and inventory_hostname in groups['drinfra'])
  tags: [ 'infra_build_nodes', 'infra_configure', 'never' ]

- name: define infra_license
  set_fact:
    infra_license: true
  when:
    - deploy | default(false) | bool
    - inventory_hostname in groups['infra'] or (customer.disaster_recovery and inventory_hostname in groups['drinfra'])
  tags: [ 'infra_license', 'never' ]

- name: define check_csr_license
  set_fact:
    check_csr_license: true
  when:
    - deploy | default(false) | bool
    - inventory_hostname in groups['infra'] or (customer.disaster_recovery and inventory_hostname in groups['drinfra'])
  tags: [ 'infra_check_csr_license', 'always' ]

- name: define get_release
  set_fact:
    get_release: true
  when:
    - deploy | default(false) | bool
    - inventory_hostname in groups['stack'] or (customer.disaster_recovery and inventory_hostname in groups['dr'])
  tags: [ 'get_release', 'vm_creation' ]

- name: define create_vms_iso
  set_fact:
    create_vms_iso: true
  when:
    - deploy | default(false) | bool
    - inventory_hostname in groups['stack'] or (customer.disaster_recovery and inventory_hostname in groups['dr'])
    - customer.name | lower is search('mdr') or bfiso | default(false) | bool
    - not (inventory_hostname in groups['infra'] or (customer.disaster_recovery and inventory_hostname in groups['drinfra']))
  tags: vm_creation

- name: define rollback_vms_iso
  set_fact:
    rollback_vms_iso: true
  when:
    - rollback | default(false) | bool
    - inventory_hostname in groups['stack'] or (customer.disaster_recovery and inventory_hostname in groups['dr'])
    - customer.name | lower is search('mdr') or bfiso | default(false) | bool
    - not (inventory_hostname in groups['infra'] or (customer.disaster_recovery and inventory_hostname in groups['drinfra']))
  tags: vm_creation

- name: define harden_vms
  set_fact:
    harden_vms: true
  when:
    - deploy | default(false) | bool
    - inventory_hostname in groups['stack'] or (customer.disaster_recovery and inventory_hostname in groups['dr'])
    - customer.name | lower is search('mdr') or bfiso | default(false) | bool
  tags: vm_hardening

- name: define install_splunk
  set_fact:
    install_splunk: true
  when:
    - deploy | default(false) | bool
    - inventory_hostname in groups['stack'] or (customer.disaster_recovery and inventory_hostname in groups['dr'])
    - customer.name | lower is search('mdr')
  tags: integ_splunk

- name: define create_vms_ova
  set_fact:
    create_vms_ova: true
  when:
    - deploy | default(false) | bool
    - inventory_hostname in groups['stack'] or (customer.disaster_recovery and inventory_hostname in groups['dr'])
    - customer.name | lower is not search('mdr')
    - not bfiso | default(false) | bool
    - not (inventory_hostname in groups['infra'] or (customer.disaster_recovery and inventory_hostname in groups['drinfra']))
  tags: vm_creation

- name: define rollback_vms_ova
  set_fact:
    rollback_vms_ova: true
  when:
    - rollback | default(false) | bool
    - inventory_hostname in groups['stack'] or (customer.disaster_recovery and inventory_hostname in groups['dr'])
    - customer.name | lower is not search('mdr')
    - not bfiso | default(false) | bool
    - not (inventory_hostname in groups['infra'] or (customer.disaster_recovery and inventory_hostname in groups['drinfra']))
  tags: vm_creation

- name: define deploy_drs
  set_fact:
    deploy_drs: true
  when:
    - deploy | default(false) | bool
    - hostvars[groups['vcenter'][0]]['information']['deptype'] == 'h'
    - inventory_hostname in groups['stack']
    - customer.name | lower is not search('mdr')
  tags: [ 'drs_creation', 'vm_creation' ]

- name: define rollback_drs
  set_fact:
    rollback_drs: true
  when:
    - rollback | default(false) | bool
    - hostvars[groups['vcenter'][0]]['information']['deptype'] == 'h'
    - inventory_hostname in groups['stack']
    - customer.name | lower is not search('mdr')
  tags: [ 'drs_creation', 'vm_creation' ]

- name: define check_drs_creation
  set_fact:
    check_drs_creation: true
  when:
    - deploy | default(false) | bool
    - hostvars[groups['vcenter'][0]]['information']['deptype'] == 'h'
    - inventory_hostname in groups['stack']
    - customer.name | lower is not search('mdr')
  tags: [ 'drs_status', 'drs_creation', 'vm_creation' ]

- name: define check_drs_removal
  set_fact:
    check_drs_removal: true
  when:
    - rollback | default(false) | bool
    - hostvars[groups['vcenter'][0]]['information']['deptype'] == 'h'
    - inventory_hostname in groups['stack']
    - customer.name | lower is not search('mdr')
  tags: [ 'drs_status', 'drs_creation', 'vm_creation' ]

- name: define configure_vms
  set_fact:
    configure_vms: true
  when:
    - deploy | default(false) | bool
    - inventory_hostname in groups['stack'] or (customer.disaster_recovery and inventory_hostname in groups['dr'])
    - customer.name | lower is not search('mdr')
    - not bfiso | default(false) | bool
    - not (inventory_hostname in groups['infra'] or (customer.disaster_recovery and inventory_hostname in groups['drinfra']))
  tags: [ 'vm_configuration' ]

- name: define push_puppet
  set_fact:
    push_puppet: true
  when:
    - deploy | default(false) | bool
    - inventory_hostname in groups['stack'] or (customer.disaster_recovery and inventory_hostname in groups['dr'])
    - customer.name | lower is not search('mdr')
    - not bfiso | default(false) | bool
    - not (inventory_hostname in groups['infra'] or (customer.disaster_recovery and inventory_hostname in groups['drinfra']))
  tags: puppet

- name: define rollback_puppet
  set_fact:
    rollback_puppet: true
  when:
    - rollback | default(false) | bool
    - inventory_hostname in groups['stack'] or (customer.disaster_recovery and inventory_hostname in groups['dr'])
    - customer.name | lower is not search('mdr')
    - not bfiso | default(false) | bool
    - not (inventory_hostname in groups['infra'] or (customer.disaster_recovery and inventory_hostname in groups['drinfra']))
  tags: puppet

- name: define configure_ppp_vms
  set_fact:
    configure_ppp_vms: true
  when:
    - deploy | default(false) | bool
    - customer.disaster_recovery
    - inventory_hostname in groups['stack'] or inventory_hostname in groups['dr']
    - customer.name | lower is not search('mdr')
    - not bfiso | default(false) | bool
    - not (inventory_hostname in groups['infra'] or (customer.disaster_recovery and inventory_hostname in groups['drinfra']))
  tags: vm_ppp_configuration

- name: define splunk_mop_fix
  set_fact:
    splunk_mop_fix: true
  when:
    - deploy | default(false) | bool
    - inventory_hostname in groups['stack'] or (customer.disaster_recovery and inventory_hostname in groups['dr'])
    - customer.name | lower is not search('mdr')
    - not bfiso | default(false) | bool
    - customer.release is search('9.1.3')
    - not (inventory_hostname in groups['infra'] or (customer.disaster_recovery and inventory_hostname in groups['drinfra']))
  tags: splunk_mop

#- name: define check_requiretty
#  set_fact:
#    check_requiretty: true
#  when:
#    - deploy | default(false) | bool
#    - inventory_hostname in groups['stack'] or (inventory_hostname in groups['dr'] and customer.disaster_recovery)
#  tags: check_requiretty
