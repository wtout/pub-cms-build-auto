---
# tasks file for puppet
- block:
  - block:
    - name: check VM reachable
      shell: ping {{ ansible_host }} -c 1
      register: pp_vm_reachable
      check_mode: no
      ignore_errors: true
      delegate_to: localhost
    - block:
      - name: check VM credentials
        wait_for_connection:
          timeout: 6
        register: pp_vm_creds1
        ignore_errors: true
        check_mode: no
      - name: Update SSH password
        set_fact:
          ansible_ssh_pass: "{{ postppp }}"
        no_log: true
        when:
          - pp_vm_creds1 is failed
          - pp_vm_creds1.msg is search('Invalid/incorrect username/password')
      when: pp_vm_reachable is succeeded
    when:
      - ansible_ssh_pass != postppp
      - inventory_hostname is not search('em7')

  - include_tasks: task_delete_certificates.yml
  - include_tasks: task_add_vm_to_class.yml
  - include_tasks: task_generate_cert_for_em7.yml
  - include_tasks: task_generate_cert_for_nonem7.yml
  - include_tasks: task_puppet_agent_test.yml

  when:
    - push_puppet | default(false) | bool
  tags: puppet

- block:
  - name: check VM reachable
    shell: ping {{ ansible_host }} -c 1
    register: pp_vm_reachable
    check_mode: no
    ignore_errors: true
    delegate_to: localhost
  - include_tasks: task_remove_vm_from_class.yml
    when: pp_vm_reachable is succeeded
  when:
    - rollback_puppet | default(false) | bool
  tags: puppet
