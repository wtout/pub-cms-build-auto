---
# Tasks to generate certificate for vm
- block:
  - name: check if puppet agent is installed
    shell: $(which yum) list installed puppet-agent || echo "No puppet-agent installed"
    check_mode: no
    register: puppet_installed
    until: puppet_installed is succeeded
    ignore_errors: true
  - block:
    - name: Download Puppet to VM
      get_url:
        url: "https://{{ puppet.fqdn }}:8140/packages/current/install.bash"
        dest: /tmp
        url_username: "{{ hostvars[groups['puppet']|first]['ansible_user'] }}"
        url_password: "{{ hostvars[groups['puppet']|first]['ansible_ssh_pass'] }}"
        validate_certs: no
      register: download_action
      until: download_action is succeeded
      retries: 7
    - name: Install Puppet on VM
      command: bash /tmp/install.bash
      become: "{{ true if inventory_hostname is search('em7') else false }}"
      register: puppet_install
      until: puppet_install is succeeded
      retries: 5
      delay: 5
      when: download_action is succeeded
    when: "'No puppet-agent installed' in puppet_installed.stdout"
  - include_tasks: task_disable_puppet_sync.yml
  tags: puppet
