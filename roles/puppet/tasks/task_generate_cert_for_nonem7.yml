---
# Tasks to generate certificate for non-em7 vm
- block:
  - name: check if puppet agent is installed
    shell: $(which yum) list installed puppet-agent || echo "No puppet-agent installed"
    check_mode: no
    register: puppet_installed
    ignore_errors: true
  - block:
    - name: Download Puppet to non-EM7 VM
      get_url:
        url: "https://{{ puppet.fqdn }}:8140/packages/current/install.bash"
        dest: /tmp
        url_username: "{{ hostvars[groups['puppet']|first]['ansible_user'] }}"
        url_password: "{{ hostvars[groups['puppet']|first]['ansible_ssh_pass'] }}"
        validate_certs: no
      register: download_action
    - name: Install Puppet on non-EM7 VM
      command: bash /tmp/install.bash
      register: puppet_install
      until: puppet_install is succeeded
      retries: 3
      delay: 5
      when: download_action is succeeded
      notify:
        - puppet sign certs
    - name: wait for certificate to be created
      shell: >
        puppet cert list {{ vm.name }}.{{ sysconfig.domain_name }} || echo 'Found no certificate'
      become: "{{ true if (puppet.vmname is search('01') or puppet.vmname is search('02')) else false }}"
      register: cert_exists
      until: cert_exists.stdout is not search('Found no certificate')
      retries: 3
      delay: 5
      delegate_to: "{{ groups['puppet']|first }}"
    when: "'No puppet-agent installed' in puppet_installed.stdout"
  when: inventory_hostname is not search('em7')
  tags: puppet

- name: flush handlers
  meta: flush_handlers
  tags: puppet
