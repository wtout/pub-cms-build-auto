---
# Tasks to wait for the certificate to be created
- block:
  - name: wait for certificate to be created
    shell: >
      puppet cert list {{ (ansible_user + '.') if inventory_hostname is search('em7') else '' }}{{ vm.name }}.{{ sysconfig.domain_name }} || echo 'Found no certificate'
    become: true
    register: cert_exists
    until: cert_exists.stdout is not search('Found no certificate')
    retries: 5
    delay: 5
    delegate_to: "{{ groups['puppet']|first }}"
  - name: puppet sign certs
    shell: >
      /usr/local/bin/puppet cert sign {{ (ansible_user + '.') if inventory_hostname is search('em7') else '' }}{{ vm.name }}.{{ sysconfig.domain_name }}
    register: psc
    until: psc is succeeded
    retries: 5
    become: true
    ignore_errors: true
    delegate_to: "{{ groups['puppet']|first }}"
    when: cert_exists|default({}) is succeeded
  tags: puppet
