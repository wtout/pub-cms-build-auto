---
# tasks to get the license status for the EM7 VM
- block:
  - name: "vm_configuration: make DB01 primary"
    include_role:
      name: vm_configuration_ova
      tasks_from: task_make_db01_primary.yml
  - include_tasks: task_em7_get_license_info.yml
  - name: define lic_status
    set_fact:
      lic_status: "{{ ((licenses_status1.stdout_lines|default([]) | select('search', vm.name))[-1:] | join).split('\t') if groups['em7']|length == 1 else ((licenses_status1.stdout_lines|default([]) | select('search', hostvars[groups['em7db']|first]['vm']['name']))[-1:] | join).split('\t') if inventory_hostname is regex('em7(dc|mc|prt)') and inventory_hostname is not search('dr') else ((licenses_status1.stdout_lines|default([]) | select('search', vm.name))[-1:] | join).split('\t') if licenses_status1.stdout_lines|default([]) | select('search', vm.name) | length >= 1 else ((licenses_status2.stdout_lines|default([]) | select('search', hostvars[groups['drem7db']|first]['vm']['name']))[-1:] | join).split('\t') if inventory_hostname is regex('drem7(dc|mc|prt)') else ((licenses_status2.stdout_lines|default([]) | select('search', vm.name))[-1:] | join).split('\t') }}"
  - ansible.builtin.assert:
      that:
        - lic_status != []
        - lic_status != ['']
        - lic_status[1] == '1'
      fail_msg: 'This EM7 host is not licensed. Please ensure it is licensed before proceeding further with the Build process'
  - block:
    - name: get date from host
      ansible.builtin.shell:
        cmd: date +"%Y-%m-%d %H:%M:%S"
      register: curr_date
      check_mode: no
    - ansible.builtin.assert:
        that:
          - lic_status|last > curr_date.stdout
        fail_msg: 'This EM7 host has an expired license. Please renew the license before proceeding further with the Build process'
    when: lic_status|last != 'NULL'
  when:
    - inventory_hostname is search('em7')
  tags: puppet
