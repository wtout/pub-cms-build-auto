---
# Tasks to add vm to puppet class
- block:
  - name: define VM's puppet class names list
    set_fact:
      vmtype_class_list: "{{ [class_list1] + [class_list2] + [class_list3] if class_list3 != '' else [class_list1] + [class_list2] }}"
    vars:
      class_list1: "{{ 'EM7QSUtils' if inventory_hostname is search('em7') else 'QSUtils' }}"
      class_list2: "{{ 'EM7PrimaryDB' if (inventory_hostname is search('em7db') and inventory_hostname is search('01')) else 'EM7SecondaryDB' if (inventory_hostname is search('em7db') and inventory_hostname is search('02')) else 'EM7ApplicationServer' if inventory_hostname is search('em7prt') else 'EM7DataCollector' if (inventory_hostname is search('em7dc') and customer.release is search('9.2')) else 'EM7MessageCollector' if (inventory_hostname is search('em7mc') and customer.release is search('9.2')) else 'LinuxJumpServer' if inventory_hostname is search('lnxjmp') else 'RelayServer' if inventory_hostname is search('rly') else 'SplunkSearchHead01' if (inventory_hostname is search('splsrc') and inventory_hostname is search('01')) else 'SplunkSearchHead02' if (inventory_hostname is search('splsrc') and inventory_hostname is search('02')) else 'SplunkIndexer' if inventory_hostname is search('splind') else 'SplunkClusterMaster' if inventory_hostname is search('splmas') else 'SplunkDeployer' if inventory_hostname is search('spldpl') else '' }}"
      class_list3: "{{ 'MariaDBPrimary' if (inventory_hostname is search('rly01') and 'dr' not in group_names) else '' }}"
  - name: add VM to puppet classes
    include_tasks:
      file: task_update_node.yml
      apply:
        vars:
          - class_name: "{{ class_item }}"
          - action: 'add'
    loop: "{{ vmtype_class_list }}"
    loop_control:
      loop_var: class_item
    when:
      - class_item != ''
  tags: puppet
