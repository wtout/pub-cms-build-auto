---
# Tasks to rebuild host
- block:
  - name: reset SSH password
    set_fact:
      ansible_ssh_pass: "{{ preppp }}"
      ansible_become_pass: "{{ preppp }}"
    no_log: true

  - include_role:
      name: "{{ auto_dir + '/roles/vm_creation' }}"
    vars:
      create_vms_ova: false
      rollback_vms_ova: true

  - include_role:
      name: "{{ auto_dir + '/roles/vm_creation' }}"
    vars:
      create_vms_ova: true
      rollback_vms_ova: false

  - include_role:
      name: "{{ auto_dir + '/roles/vm_configuration' }}"
    vars:
      configure_vms: true

  - include_tasks: task_delete_certificates.yml
  - include_tasks: task_add_vm_to_class.yml
  - include_tasks: task_generate_cert.yml
  - include_tasks: task_generate_cert_for_em7.yml
  - include_tasks: task_check_certificate.yml
  - name: "relaunch puppet push #3"
    shell: /usr/local/bin/puppet agent --server {{ puppet.fqdn }} --test
    async: 30
    poll: 0
  - name: Update SSH password
    set_fact:
      ansible_ssh_pass: "{{ postppp }}"
      ansible_become_pass: "{{ postppp }}"
    no_log: true
  - name: check updated VM credentials
    wait_for_connection:
      sleep: 10
      timeout: "{{ 600 if inventory_hostname is search('em7') else 2700 }}"
    register: repush3_status
    ignore_errors: true
  - assert:
      that:
        - repush3_status is succeeded
      fail_msg: "Puppet could not be pushed succesfully on {{ inventory_hostname }}"
  tags: puppet
