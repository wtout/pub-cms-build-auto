---
# Tasks to perform puppet agent test
- block:
  - name: check if puppet agent test is already running
    stat:
      path: '/opt/puppetlabs/puppet/cache/state/agent_catalog_run.lock'
    register: puppet_push_running

  - block:
    - block:
      - name: Update SSH password
        set_fact:
          ansible_ssh_pass: "{{ postppp }}"
        no_log: true
        when: ansible_ssh_pass != postppp
      - name: check updated VM credentials
        wait_for_connection:
          sleep: 10
          timeout: "{{ 2700 if customer.disaster_recovery else 1800 }}"
        register: connection_status1
      - name: reset SSH password
        set_fact:
          ansible_ssh_pass: "{{ postppp }}"
        no_log: true
        when: connection_status1 is failed
    - name: wait for puppet push to finish
      wait_for:
        path: '/opt/puppetlabs/puppet/cache/state/agent_catalog_run.lock'
        state: absent
        timeout: 1800
    - name: get puppet push status
      shell: "egrep ': Applied catalog in [1-9]+.*seconds' /var/log/messages || echo 'Puppet push failed'"
      register: puppet_push_status1
    - name: check if puppet push completed successfully
      assert:
        that: puppet_push_status1.stdout is not search('Puppet push failed')
        fail_msg: 'Puppet push did not complete successfully'
    when: puppet_push_running.stat.exists

  - block:
    - name: check if puppet push was started
      shell: >
        egrep "Applying configuration version '[0-9]+'" /var/log/messages || echo 'Puppet push not started'
      register: puppet_push_started
      check_mode: no
    - debug:
        msg: 'Puppet push was never started. Will start it'
      when: puppet_push_started.stdout is search('Puppet push not started')
    - block:
      - name: get previous puppet push status if any
        shell: >
          egrep ': Applied catalog in [1-9]+.*seconds' /var/log/messages || echo 'Puppet push failed'
        register: puppet_push_status2
        check_mode: no
      - name: display previous puppet push status
        debug:
          msg: "{{ 'Previous Puppet push did not complete successfully. Re-running puppet push' if puppet_push_status2.stdout is search('Puppet push failed') else 'Previous Puppet push completed successfully' }}"
      - name: trigger puppet push start
        set_fact:
          start_puppet_push: 'false'
        when: puppet_push_status2.stdout is not search('Puppet push failed')
      when: puppet_push_started.stdout is not search('Puppet push not started')

    - block:
      - name: puppet agent test
        shell: /usr/local/bin/puppet agent --server {{ puppet.fqdn }} --test
        register: puppet_agent
        async: 30
        poll: 0
        when: not ansible_check_mode
      - name: Wait for puppet agent test to start
        wait_for:
          delay: "{{1 if ansible_ssh_pass == postppp else 20}}"
          path: '/opt/puppetlabs/puppet/cache/state/agent_catalog_run.lock'
          state: present
          timeout: 1800
        when:
          - not ansible_check_mode
      - name: Update SSH password
        set_fact:
          ansible_ssh_pass: "{{ postppp }}"
        no_log: true
      - name: check updated VM credentials
        wait_for_connection:
          sleep: 10
          timeout: "{{ 2700 if customer.disaster_recovery else 1800 }}"
        register: connection_status2
      - name: reset SSH password
        set_fact:
          ansible_ssh_pass: "{{ preppp }}"
        no_log: true
        when: connection_status2 is failed
      - name: Wait for puppet push to finish
        wait_for:
          path: '/opt/puppetlabs/puppet/cache/state/agent_catalog_run.lock'
          state: absent
          timeout: 1800
      - name: get puppet push status
        shell: "egrep ': Applied catalog in [1-9]+.*seconds' /var/log/messages || echo 'Puppet push failed'"
        register: puppet_push_status2
      - name: check if puppet push completed successfully
        assert:
          that: puppet_push_status2.stdout is not search('Puppet push failed')
          fail_msg: 'Puppet push did not complete successfully'
      when:
        - not ansible_check_mode
        - start_puppet_push | default(true) | bool
    when:
      - not puppet_push_running.stat.exists

  - include_tasks:
      file: task_puppet_push.yml
      apply:
        vars:
          push_num: "{{ loop_item }}"
    loop: "{{ range(1, 5 + 1)|list }}"
    loop_control:
      loop_var: loop_item
  when:
     - inventory_hostname is not search('em7')
  tags: puppet
