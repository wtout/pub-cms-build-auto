---
# Task file to add DNS records
- block:
  - name: Add stack DNS records
    nsupdate:
      server: "{{ sysconfig.primary.dns_servers[0] }}"
      record: "{{ vm.name }}"
      value: "{{ netconfig.ipaddress1 if not inventory_hostname is search('csr') else netconfig.ipaddress3 }}"
      zone: "{{ sysconfig.primary.domain_name }}"
      state: present
    when:
      - add_dns_records | default(false) | bool
      - "'stack' in group_names"
  
  - name: Add DR DNS records
    nsupdate:
      server: "{{ sysconfig.secondary.dns_servers[0] }}"
      record: "{{ vm.name }}"
      value: "{{ netconfig.ipaddress1 if not inventory_hostname is search('csr') else netconfig.ipaddress3 }}"
      zone: "{{ sysconfig.secondary.domain_name }}"
      state: present
    when:
      - add_dns_records | default(false) | bool
      - customer.disaster_recovery
      - "'dr' in group_names"
  
  - name: Add additional DNS records
    nsupdate:
      server: "{{ sysconfig.primary.dns_servers[0] }}"
      record: "{{ list_item.record }}"
      value: "{{ list_item.value }}"
      zone: "{{ sysconfig.primary.domain_name }}"
      state: present
    loop: "{{ dns_records }}"
    loop_control:
      loop_var: list_item
    when:
      - add_dns_records | default(false) | bool
      - ansible_play_batch | reject('search', 'dr|vcenter|bastion|puppet|nexus') | list | length >= 1
  
  - name: Add additional DR DNS records
    nsupdate:
      server: "{{ sysconfig.secondary.dns_servers[0] }}"
      record: "{{ list_item.record }}"
      value: "{{ list_item.value }}"
      zone: "{{ sysconfig.secondary.domain_name }}"
      state: present
    loop: "{{ dr_dns_records }}"  
    loop_control:
      loop_var: list_item
    when:
      - add_dns_records | default(false) | bool
      - customer.disaster_recovery
      - ansible_play_batch | select('search', 'dr') | reject('search', 'vcenter|bastion|puppet|nexus') | list | length >= 1

  - name: Remove DNS records
    nsupdate:
      server: "{{ sysconfig.primary.dns_servers[0] }}"
      record: "{{ vm.name }}"
      value: "{{ netconfig.ipaddress1 if not inventory_hostname is search('csr') else netconfig.ipaddress3 }}"
      zone: "{{ sysconfig.primary.domain_name }}"
      state: absent
    when:
      - rollback_dns_records | default(false) | bool
      - "'stack' in group_names"

  - name: Remove DR DNS records
    nsupdate:
      server: "{{ sysconfig.secondary.dns_servers[0] }}"
      record: "{{ vm.name }}"
      value: "{{ netconfig.ipaddress1 if not inventory_hostname is search('csr') else netconfig.ipaddress3 }}"
      zone: "{{ sysconfig.secondary.domain_name }}"
      state: absent
    when:
      - rollback_dns_records | default(false) | bool
      - customer.disaster_recovery
      - "'dr' in group_names"

  - name: Remove additional DNS records
    nsupdate:
      server: "{{ sysconfig.primary.dns_servers[0] }}"
      record: "{{ list_item.record }}"
      value: "{{ list_item.value }}"
      zone: "{{ sysconfig.primary.domain_name }}"
      state: absent
    loop: "{{ dns_records }}"
    loop_control:
      loop_var: list_item
    when:
      - rollback_dns_records | default(false) | bool
      - ansible_play_batch | reject('search', 'dr|vcenter|bastion|puppet|nexus') | list | length >= 1

  - name: Remove additional DR DNS records
    nsupdate:
      server: "{{ sysconfig.secondary.dns_servers[0] }}"
      record: "{{ dr_list_item.record }}"
      value: "{{ dr_list_item.value }}"
      zone: "{{ sysconfig.secondary.domain_name }}"
      state: absent
    loop: "{{ dr_dns_records }}"
    loop_control:
      loop_var: dr_list_item
    when:
      - rollback_dns_records | default(false) | bool
      - customer.disaster_recovery
      - ansible_play_batch | select('search', 'dr') | reject('search', 'vcenter|bastion|puppet|nexus') | list | length >= 1
  delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}" 
  tags: [ 'infra_dns_records', 'infra_configure', 'infra_build_nodes', 'never' ]
