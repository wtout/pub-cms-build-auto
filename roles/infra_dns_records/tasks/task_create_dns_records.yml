---
# Task file to add DNS records
- block:
  - block:
    - name: Add primary DNS records
      community.general.nsupdate:
        server: "{{ sysconfig.primary.dns_servers[0] }}"
        record: "{{ vm.name }}"
        value: "{{ netconfig.nic1.ipaddress if  inventory_hostname is not search('csr') else netconfig.nic3.ipaddress }}"
        zone: "{{ sysconfig.primary.domain_name }}"
        state: present
    - name: Add primary reverse DNS records
      community.general.nsupdate:
        server: "{{ sysconfig.primary.dns_servers[0] }}"
        record: "{{ (netconfig.nic1.ipaddress if inventory_hostname is not search('csr') else netconfig.nic3.ipaddress).split('.') | reverse | join('.') + '.in-addr.arpa' }}"
        value: "{{ vm.name + '.' + sysconfig.primary.domain_name }}"
        type: "PTR"
        zone: "{{ (netconfig.nic1.ipaddress if inventory_hostname is not search('csr') else netconfig.nic3.ipaddress).split('.')[:-1] | reverse | join('.') + '.in-addr.arpa' }}"
        state: present
      ignore_errors: true
    when:
      - "'stack' in group_names"
  
  - block:
    - name: Add secondary DNS records
      community.general.nsupdate:
        server: "{{ sysconfig.secondary.dns_servers[0] }}"
        record: "{{ vm.name }}"
        value: "{{ netconfig.nic1.ipaddress if inventory_hostname is not search('csr') else netconfig.nic3.ipaddress }}"
        zone: "{{ sysconfig.secondary.domain_name }}"
        state: present
    - name: Add secondary reverse DNS records
      community.general.nsupdate:
        server: "{{ sysconfig.secondary.dns_servers[0] }}"
        record: "{{ (netconfig.nic1.ipaddress if inventory_hostname is not search('csr') else netconfig.nic3.ipaddress).split('.') | reverse | join('.') + '.in-addr.arpa' }}"
        value: "{{ vm.name + '.' + sysconfig.secondary.domain_name }}"
        type: "PTR"
        zone: "{{ (netconfig.nic1.ipaddress if inventory_hostname is not search('csr') else netconfig.nic3.ipaddress).split('.')[:-1] | reverse | join('.') + '.in-addr.arpa' }}"
        state: present
      ignore_errors: true
    when:
      - customer.disaster_recovery
      - "'dr' in group_names"
  
  - name: Create Additional Primary DNS Records
    include_tasks:
      file: task_manage_adtl_records.yml
      apply:
        vars:
          dns_server: "{{ sysconfig.primary.dns_servers[0] }}"
          dns_zone: "{{ sysconfig.primary.domain_name }}"
          dns_state: 'present'
          dns_loop: "{{ dns_records }}"
    when:
      - ansible_play_batch | reject('search', 'dr|vcenter|bastion|puppet|nexus') | list | length >= 1
  
  - name: Create Additional Secondary DNS Records
    include_tasks:
      file: task_manage_adtl_records.yml
      apply:
        vars:
          dns_server: "{{ sysconfig.secondary.dns_servers[0] }}"
          dns_zone: "{{ sysconfig.secondary.domain_name }}"
          dns_state: 'present'
          dns_loop: "{{ dr_dns_records }}"  
    when:
      - customer.disaster_recovery
      - ansible_play_batch | select('search', 'dr') | reject('search', 'vcenter|bastion|puppet|nexus') | list | length >= 1

  delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}" 
  tags: [ 'infra_dns_records', 'infra_configure', 'infra_build_nodes', 'never' ]
