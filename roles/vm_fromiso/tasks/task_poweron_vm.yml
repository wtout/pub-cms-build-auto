---
# Tasks to power-on the VM
- block:
  - name: Power-on VM
    vmware_guest:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      name: "{{ vm.name }}"
      datacenter: "{{ datacenter.name }}"
      cluster: "{{ hostvars[groups['vcenter'][0]]['information']['cluster'] }}"
      state: poweredon
      validate_certs: no
    ignore_errors: true
    delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"
    environment:
      http_proxy: ''
      https_proxy: ''
  - name: wait 120 seconds for VM to become reachable
    wait_for_connection:
      timeout: 120
  tags: vm_creation