---
# tasks file for vm_creation
- block:
  - name: purge known hosts file
    copy:
      dest: ~/.ssh/known_hosts
      content: ''
      force: yes
    run_once: true
    delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"

  - block:
    - block:
      - name: check VM reachable
        command: ping {{ ansible_host }} -c 1
        register: vcr_vm_reachable
        ignore_errors: true
        check_mode: no
        delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"
      - block:
        - name: switch to cmsbuild user
          set_fact:
            ansible_user: "{{ vm_svc_user }}"
        - name: check connection
          wait_for:
            host: "{{ ansible_host }}"
            port: 22
            timeout: 10
          register: vcr_vm_connection
          ignore_errors: true
          check_mode: no
          delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"
        - debug:
            msg: "VM hardening is enabled. Nothing to do"
          when: vcr_vm_connection is succeeded
        - name: set flag to not create and configure the VMs
          set_fact:
            crecon: false
          when: vcr_vm_connection is succeeded
        - name: revert user
          set_fact:
            ansible_user: "{{ credentials.username }}"
          when: vcr_vm_connection is failed
        when: vcr_vm_reachable is failed
      - block:
        - name: check VM credentials
          wait_for_connection:
            timeout: 6
          register: vcr_vm_creds
          ignore_errors: true
          check_mode: no
        - name: Update SSH password
          set_fact:
            ansible_ssh_pass: "{{ postppp }}"
          no_log: true
          when:
            - vcr_vm_creds is failed
            - vcr_vm_creds.msg is search('Invalid/incorrect username/password')
        when: vcr_vm_reachable is succeeded
      when:
        - ansible_ssh_pass != postppp
        - inventory_hostname is not search('em7')

    - include_tasks: task_create_vms.yml
    when: create_vms_iso | default(false) | bool

  - include_tasks: task_rollback_vms.yml
    when: rollback_vms_iso | default(false) | bool
  tags: vm_creation
