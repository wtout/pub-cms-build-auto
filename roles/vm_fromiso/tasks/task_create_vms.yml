---
# tasks file to create vms
- block:
  - block:
    - block:
      - include_tasks: task_create_folder.yml
        run_once: true
      when:
        - hostvars[groups['vcenter'][0]]['information']['deptype'] == 'h'

    - block:
      - include_tasks: task_create_cluster.yml
        run_once: true
      when:
        - hostvars[groups['vcenter'][0]]['information']['deptype'] == 'a'

    - include_tasks: task_create_configure_vms.yml
    when: crecon | default(true) | bool

  - name: switch to cmsbuild user
    set_fact:
      ansible_user: "{{ vm_svc_user }}"

  - include_tasks: task_update_iptables.yml
  tags: vm_creation
