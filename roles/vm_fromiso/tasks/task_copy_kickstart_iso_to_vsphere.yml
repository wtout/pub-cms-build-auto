---
# Tasks to copy the ISO file to datastore
- block:
  - name: define iso_datastore and iso_path
    set_fact:
      iso_datastore: "{{ hostvars[groups['vcenter'][0]]['information']['storage_datastore'] if hostvars[groups['vcenter'][0]]['information']['storage_datastore'] != '' else vm_ds }}"
      iso_path: "ISO{{ '/' + hostvars[groups['vcenter'][0]]['information']['storage_path'] if hostvars[groups['vcenter'][0]]['information']['storage_path'] != '' else '' }}"

  - name: create a directory on the datastore
    vsphere_file:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      datacenter: "{{ hostvars[groups['vcenter'][0]]['information']['datacenter'] }}"
      datastore: "{{ iso_datastore }}"
      path: "{{ iso_path }}"
      state: directory
      validate_certs: false
    register: ds_folder
    throttle: 1

  - include_tasks: task_poweroff_vm.yml
    when: ds_folder is succeeded

  - name: copy kickstart ISO file to vsphere
    vsphere_copy:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      datacenter: "{{ hostvars[groups['vcenter'][0]]['information']['datacenter'] }}"
      datastore: "{{ iso_datastore }}"
      src: "{{ role_path }}/files/{{ vm.name }}-kickstart.iso"
      path: "{{ iso_path }}/{{ vm.name }}-kickstart.iso"
      validate_certs: false
    when: ds_folder is succeeded

  - name: check if the installer ISO is on the datastore
    vsphere_file:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      datacenter: "{{ hostvars[groups['vcenter'][0]]['information']['datacenter'] }}"
      datastore: "{{ iso_datastore }}"
      path: "{{ iso_path }}/{{ iso_installer }}"
      state: file
      validate_certs: false
    register: iso_present
    ignore_errors: true
    when: ds_folder is succeeded
    run_once: "{{ true if hostvars[groups['vcenter'][0]]['information']['deptype'] is search('h') else false }}"

  - name: copy installer ISO file to vsphere
    vsphere_copy:
      hostname: "{{ hostvars[groups['vcenter'][0]]['information']['address'] }}"
      username: "{{ hostvars[groups['vcenter'][0]]['credentials']['username'] }}"
      password: "{{ hostvars[groups['vcenter'][0]]['credentials']['password'] }}"
      datacenter: "{{ hostvars[groups['vcenter'][0]]['information']['datacenter'] }}"
      datastore: "{{ iso_datastore }}"
      src: "{{ auto_dir }}/Packages/ISO/{{ iso_installer }}"
      dest: "{{ iso_path }}/{{ iso_installer }}"
      validate_certs: false
    async: 7200
    poll: 30
    run_once: "{{ true if hostvars[groups['vcenter'][0]]['information']['deptype'] is search('h') else false }}"
    when:
      - iso_present is failed
      - not ansible_check_mode
      - ds_folder is succeeded
  delegate_to: "{{ groups['bastion'][0] if (groups['bastion'] | length >= 1 and bastion.address != [] and bastion.address != ['']) else 'localhost' }}"
  environment:
    http_proxy: ''
    https_proxy: ''
  tags: vm_creation
