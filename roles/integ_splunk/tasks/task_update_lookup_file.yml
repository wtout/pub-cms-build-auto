---
# Tasks to update lookup file
- block:
  - name: Read customer information obtained from keeper
    ansible.builtin.shell: |
      head -1 customer_core_passwords.yml | grep '$ANSIBLE_VAULT' 1&2>/dev/null && ansible-vault view customer_core_passwords.yml --vault-password-file vault-password-file | egrep "(index\:| id\:)"
    args:
      chdir: "{{ spl_ansible_path }}"
    register: reg_read_info

  - block:
    - name: get list of customer entries from lookup file
      ansible.builtin.command: |
        cat {{ spl_wd }}/dev/mdr-splunk-env/deployer/cisco_mdr_ucases_lookup/lookups/cisco_mdr_customer_mapping.csv
      register: reg_last_entry
    - name: update lookup file
      ansible.builtin.lineinfile:
        path: "{{ spl_wd }}/dev/mdr-splunk-env/deployer/cisco_mdr_ucases_lookup/lookups/cisco_mdr_customer_mapping.csv"
        line: "{{ [(reg_read_info.stdout_lines|select('search', 'id:')|join).split(': ')|last, (reg_read_info.stdout_lines|select('search', 'index:')|join).split(': ')|last, (reg_last_entry.stdout_lines|last).split(',')|last|int + 1]|join(',') if reg_last_entry.stdout_lines|select('search', customer.shortname)|length == 0 else reg_last_entry.stdout_lines|select('search', customer.shortname)|join }}"
      register: reg_update_file
    when: reg_read_info is succeeded
  when:
    - inventory_hostname is search('splfwd')
    - reg_cust_creds is succeeded
  delegate_to: localhost
  run_once: true
  tags: integ_splunk
