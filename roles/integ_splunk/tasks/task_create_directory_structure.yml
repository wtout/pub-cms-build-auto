---
# Tasks to create the directory structure
- block:
  - name: create the directory structure
    file:
      path: "{{ dir_item }}"
      state: directory
    loop:
      - "{{ spl_wd }}"
      - "{{ spl_wd }}/dev"
      - "{{ spl_wd }}/deploy"
    loop_control:
      loop_var: dir_item
  - name: create the splunkApps symolic link
    file:
      path: "{{ spl_wd }}/deploy/splunkApps"
      src: "{{ spl_wd }}/dev/mdr-splunk-env"
      state: link
      force: yes
  - name: Ensure {{ auto_dir }}/Packages/Splunk exists
    ansible.builtin.file:
      path: "{{ auto_dir }}/Packages/Splunk"
      state: directory
  - name: Download Splunk artifacts
    get_url:
      url: "{{ spl_rpm_url }}"
      dest: "{{ auto_dir }}/Packages/Splunk/"
    register: download_action
    until: download_action is succeeded
    retries: 7
  - name: get list of Splunk artifacts
    find:
      paths: "{{ auto_dir }}/Packages/Splunk"
      file_type: file
      patterns: '*.rpm'
    register: artifacts_list
  - name: check that Splunk artifacts are found
    ansible.builtin.assert:
      that:
        - artifacts_list.matched >= 1
      fail_msg: 'Unable to find Splunk artifacts. Aborting!'
  - debug:
      msg:
        - "{{ link_item.path }}"
        - "{{ link_item.path | basename }}"
    loop: "{{ artifacts_list.files }}"
    loop_control:
      loop_var: link_item
  - name: create the splunk artifacts symbolic links
    file:
      path: "{{ spl_wd }}/deploy/{{ link_item.path | basename }}"
      src: "{{ link_item.path }}"
      state: link
      force: yes
    loop: "{{ artifacts_list.files }}"
    loop_control:
      loop_var: link_item
  delegate_to: localhost
  run_once: true
  tags: integ_splunk
  