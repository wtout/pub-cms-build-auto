---
# Validate credentials (always run)
- name: Validate credentials
  hosts: all
  any_errors_fatal: true
  max_fail_percentage: 0
  gather_facts: no

  roles:
    - role: check_creds

# Play to determine what to do and to define vm facts(always run)
- name: Define variables
  hosts: all
  any_errors_fatal: true
  max_fail_percentage: 0
  gather_facts: no

  roles:
    - role: todo
    - role: vm_facts

# Play to deploy the ssh_keys to bastion server(s), deploy the infrastructure, perform the infrastructure capacity check, and download the release package
- name: Pre-deploy preparation
  hosts: all
  any_errors_fatal: true
  max_fail_percentage: 0
  gather_facts: no

  tasks:
    - block:
      - include_role:
          name: ssh_keys
        when: configure_ssh_keys | default(false) | bool
      - include_role:
          name: infra_configure
        when: configure_infra | default(false) | bool
      - include_role:
          name: capcheck
        when: capcheck | default(false) | bool
      - include_role:
          name: get_release
        when: get_release | default(false) | bool
      - include_role:
          name: infra_dns_records
        when: add_dns_records | default(false) | bool
      - include_role:
          name: infra_build_nodes
        when: build_infra_nodes | default(false) | bool
      - include_role:
          name: infra_license
        when: infra_license | default(false) | bool
      - include_role:
          name: infra_check_csr_license
        when: check_csr_license | default(false) | bool
      when: deploy | default(false) | bool

# Play to create the VMs
- name: Deploy VMs
  hosts: all
  strategy: free
  gather_facts: no

  tasks:
    - block:
      - include_role:
          name: vm_fromiso
        when: create_vms_iso | default(false) | bool
      - include_role:
          name: vm_hardening
        when: harden_vms | default(false) | bool
      - include_role:
          name: vm_creation
        when: create_vms_ova | default(false) | bool
      when: deploy | default(false) | bool

# Play to configure the VMs and to run the puppet push
- name: Configure VMs
  hosts: all
  gather_facts: no

  tasks:
    - block:
      - include_role:
          name: integ_splunk
        when: install_splunk | default(false) | bool
      - include_role:
          name: drs_creation
        when: deploy_drs | default(false) | bool
      - include_role:
          name: vm_configuration_iso
        when: configure_vms_iso | default(false) | bool
      - include_role:
          name: vm_configuration_ova
        when: configure_vms_ova | default(false) | bool
      - include_role:
          name: puppet
        when: push_puppet | default(false) | bool
      - include_role:
          name: vm_ppp_configuration
        when: configure_ppp_vms | default(false) | bool
      - include_role:
          name: splunk_mop
        when: splunk_mop_fix | default(false) | bool
      - include_role:
          name: drs_status
        when: check_drs_creation | default(false) | bool
      when: deploy | default(false) | bool

# Play to check the VMs
- name: Check VMs
  hosts: all
  gather_facts: no

  tasks:
    - block:
      - include_role:
          name: sanity
        when: sanity_check | default(false) | bool
      when: deploy | default(false) | bool

# Play to delete the VMs
- name: Rollback VMs
  hosts: all
  order: reverse_inventory
  gather_facts: no

  tasks:
    - block:
      - include_role:
          name: puppet
        when: rollback_puppet | default(false) | bool
      - include_role:
          name: drs_creation
        when: rollback_drs | default(false) | bool
      - include_role:
          name: vm_creation
        when: rollback_vms_ova | default(false) | bool
      - include_role:
          name: vm_fromiso
        when: rollback_vms_iso | default(false) | bool
      - include_role:
          name: infra_build_nodes
        when: rollback_infra_nodes | default(false) | bool
      - include_role:
          name: infra_dns_records
        when: rollback_dns_records | default(false) | bool
      - include_role:
          name: infra_configure
        when: rollback_infra | default(false) | bool
      - include_role:
          name: drs_status
        when: check_drs_removal | default(false) | bool
      - include_role:
          name: ssh_keys
        when: rollback_ssh_keys | default(false) | bool
      when: rollback | default(false) | bool
